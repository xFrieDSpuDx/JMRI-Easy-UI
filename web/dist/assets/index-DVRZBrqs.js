(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const ie={roster:"panelRoster",turnouts:"panelTurnouts",lights:"panelLights",settings:"panelSettings"},Ye={roster:"navRoster",turnouts:"navTurnouts",lights:"navLights",settings:"navSettings"};function Qe(e){return document.getElementById(e)}function de(e){const t=String(e||"roster");for(const n of Object.keys(ie)){const a=Qe(ie[n]);a&&(n===t?a.removeAttribute("hidden"):a.setAttribute("hidden",""))}for(const n of Object.keys(Ye)){const a=Qe(Ye[n]);a&&(a.classList.toggle("active",n===t),a.setAttribute("aria-current",n===t?"page":"false"))}document.dispatchEvent(new CustomEvent("panel:changed",{detail:{name:t}}))}function _t(){document.addEventListener("click",t=>{const n=t.target.closest(".nav-btn[data-view]");if(!n)return;const a=n.getAttribute("data-view");a&&de(a)}),window.addEventListener("hashchange",()=>{const t=window.location.hash.replace(/^#/,"");Object.prototype.hasOwnProperty.call(ie,t)&&de(t)});const e=window.location.hash.replace(/^#/,"")||"roster";de(Object.prototype.hasOwnProperty.call(ie,e)?e:"roster")}function zt(){const e=document.getElementById("drawer");if(!e)return;const t=Array.from(document.querySelectorAll("#menuBtn, .menu-btn")),n=a=>{a.stopPropagation(),e.classList.toggle("open")};t.forEach(a=>a.addEventListener("click",n)),e.addEventListener("click",a=>{a.target.closest(".drawer .nav-btn")&&e.classList.remove("open")}),document.addEventListener("keydown",a=>{a.key==="Escape"&&e.classList.remove("open")}),document.addEventListener("click",a=>{e.classList.contains("open")&&(a.target.closest(".drawer, #menuBtn, .menu-btn")||e.classList.remove("open"))})}const Wt=window.location.origin;function re(e){return new URL(e,Wt).toString()}function Ae(e){const t=new Set;for(const n of e||[])n!=null&&n.id&&t.add(String(n.id).toLowerCase()),n!=null&&n.userName&&t.add(String(n.userName).toLowerCase());return t}function ke(e,t,n,a){const i=(e||"").trim();if(!i)return String(t);const s=f=>n.has(String(f).toLowerCase());if(!s(i)&&a)return i;const o=i.match(/^(.*?)(\d+)$/),r=o?o[1]:`${i} `;let l=o?parseInt(o[2],10)+1:2,d=`${r}${l}`;for(;s(d);)l+=1,d=`${r}${l}`;return d}async function V(e){const t=e.headers.get("content-type")||"",n=/application\/json/i.test(t),a=await e.text();return n&&(a.length===0||a===null)?!0:n?JSON.parse(a):a}function G(e){if(!e.ok)throw new Error(`${e.status} ${e.statusText}`)}async function I(e){const t=await fetch(re(e),{credentials:"same-origin",headers:{Accept:"application/json"}});return G(t),V(t)}async function dt(e){const t=await fetch(re(e),{credentials:"same-origin",method:"POST",headers:{Accept:"application/json"}});return G(t),V(t)}async function X(e,t,n="POST"){const a=await fetch(re(e),{method:n,credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:t});return G(a),V(a)}async function mt(e,t){const n=await fetch(re(e),{method:"POST",credentials:"same-origin",body:t});return G(n),V(n)}async function $(e,t,n){const a=await fetch(t,{method:e,headers:{"Content-Type":"application/json"},body:n?JSON.stringify({data:n}):void 0});return G(a),V(a)}const Z={shortAddress:1,longAddrMsb:17,longAddrLsb:18,config:29},et={longAddressMode:32},Vt=192;async function Gt(e){const n=(await Ie()||[]).find(a=>((a==null?void 0:a.id)||"")===e);return(n==null?void 0:n.fileName)||null}async function Xt(){var e;try{const t=await I("/json/railroad"),n=Array.isArray(t)?t.find(a=>a&&a.type==="railroad"):null;return((e=n==null?void 0:n.data)==null?void 0:e.name)||"My Railroad"}catch{return"My Railroad"}}async function Ie(e={}){const n=!!e.fresh?`/api/roster?t=${Date.now()}`:"/api/roster";return I(n)}async function Jt(e){const t=`/api/roster/decoder?id=${encodeURIComponent(e)}`;return I(t)}async function Kt(e){const t=new URLSearchParams;return t.set("file",e),X("/api/roster/delete",t)}async function Zt(e,t){const n=new URLSearchParams;return n.set("file",e),n.set("id",t.id||""),n.set("address",t.address||""),n.set("road",t.road||""),n.set("number",t.number||""),n.set("owner",t.owner||""),n.set("model",t.model||""),Object.prototype.hasOwnProperty.call(t,"image")&&n.set("image",t.image||""),X("/api/roster/add",n)}async function Yt(e,{family:t,model:n,manufacturer:a,mfgId:i,mfgName:s,productId:o,modelId:r}){if(!e)throw new Error("Missing rosterId");if(!t||!n)throw new Error("Missing family/model");const l=new URLSearchParams({id:e,family:t,model:n});return a&&l.append("manufacturer",a),i!==null&&typeof i<"u"&&l.append("mfgId",String(i)),o!==null&&typeof o<"u"&&l.append("productId",String(o)),s!==null&&typeof s<"u"&&l.append("mfgName",String(s)),r!==null&&typeof r<"u"&&l.append("modelId",String(r)),X("/api/roster/decoder/save",l)}async function Qt(e,t){const n=new FormData;return n.append("image",t,t.name),mt(`/api/roster/image?id=${encodeURIComponent(e)}`,n)}async function en(e,t){const n=new FormData;return n.append("file",e,t),mt("/api/roster/add",n)}async function $e(e){return I(`/api/roster/fn/list?file=${encodeURIComponent(e)}`)}async function tn(e,t){const n=new URLSearchParams;n.set("file",e);for(const a of t)n.append("num[]",String(a.num??"")),n.append("label[]",String(a.label??"")),n.append("lockable[]",a.lockable?"true":"false"),n.append("img[]",String(a.img??"")),n.append("imgSel[]",String(a.imgSel??""));return X("/api/roster/fn/save",n)}async function nn(){const e=await I("/api/jmri/read?list=1,17,18,29"),t=(e==null?void 0:e.values)??e??{},n=Number(t[String(Z.config)]);if(!Number.isFinite(n))return"";if((n&et.longAddressMode)===et.longAddressMode){const s=Number(t[String(Z.longAddrMsb)]),o=Number(t[String(Z.longAddrLsb)]);if(!Number.isFinite(s)||!Number.isFinite(o))return"";const r=256*(s-Vt)+o;return String(r)}const i=Number(t[String(Z.shortAddress)]);return Number.isFinite(i)?String(i):""}async function an(e,t={}){const n=t.mode==="ops"?"ops":"service",a=Number(e);if(!Number.isFinite(a)||a<=0||a>9999)throw new Error("Invalid DCC address");const i=new URLSearchParams;if(i.set("mode",n),i.set("newAddress",String(a)),n==="ops"){const o=Number(t.currentAddress),r=typeof t.currentLong=="boolean"?t.currentLong:o>=128;if(!Number.isFinite(o)||o<=0)throw new Error("Ops mode requires { currentAddress, currentLong } to reach the decoder");i.set("address",String(o)),i.set("long",String(!!r))}const s=await X("/api/jmri/writeAddress",i);if(!s||s.ok!==!0)throw new Error(s&&s.message||"Address write failed");return s}async function on({dccAddress:e}={}){const t=await fetch("/api/decoder/identify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dccAddress:e})});if(!t.ok){let n="";try{n=await t.text()}catch(a){console.warn(a)}throw new Error(n||"Failed to read decoder")}return t.json()}async function sn(){let e=null,t=null;try{if(e=await I("/json/turnouts"),e)return e}catch(n){t=n}throw t||new Error("No turnout data")}async function rn(){let e=null,t=null;try{if(e=await I("/api/lights"),e)return e}catch(n){t=n}throw t||new Error("No light data")}let H=null;function ln(e){H=e}async function cn(){return I("/api/store/user/file")}async function De(e){const t=e?`/api/store/user?file=${encodeURIComponent(e)}`:"/api/store/user";return dt(t)}async function ft(){return I("/api/connections")}async function un(e){return dt(`/api/connections/select?systemPrefix=${e}`)}const tt="AutoStorePanels.xml";let nt=0,Q=null;async function dn(){await mn(),await fn()}async function mn(e=800){if(!H){let t="";try{const n=await cn();t=(n==null?void 0:n.fileName)||tt}catch{t=tt}ln(t)}clearTimeout(nt),nt=setTimeout(()=>{De(H).catch(()=>{})},e)}async function fn(){const e=await ft();pt(e)}function pt(e){Q=e.find(t=>t.active)??null}(function(){const t="__APP_BUSY_OVERLAY__";if(window[t])return;const n={count:0,dialogEl:null,fallbackEl:null,labelEl:null,watchdogTimer:null,supportsDialog(){return typeof HTMLDialogElement<"u"},ensureOverlay(){if(!(this.dialogEl||this.fallbackEl))if(this.supportsDialog()){const a=document.createElement("dialog");a.id="appBusy",a.setAttribute("aria-live","polite"),a.setAttribute("aria-busy","true"),a.addEventListener("cancel",s=>s.preventDefault());const i=document.createElement("div");i.className="panel",i.innerHTML=`
          <div class="spinner" aria-hidden="true"></div>
          <div class="label" id="appBusyLabel">Working…</div>
        `,a.appendChild(i),document.body.appendChild(a),this.dialogEl=a,this.labelEl=i.querySelector("#appBusyLabel")}else{const a=document.createElement("div");a.id="appBusy",a.innerHTML=`
          <div class="panel" role="alert" aria-live="assertive">
            <div class="spinner" aria-hidden="true"></div>
            <div class="label" id="appBusyLabel">Working…</div>
          </div>
        `,document.body.appendChild(a),this.fallbackEl=a,this.labelEl=a.querySelector("#appBusyLabel")}},openOverlay(a){this.ensureOverlay();const i=document.getElementById("appBusy");i&&(i.style.display="grid"),this.labelEl&&(this.labelEl.textContent=a||"Working…"),this.dialogEl?(this.dialogEl.open||this.dialogEl.showModal(),document.body.setAttribute("aria-busy","true")):this.fallbackEl&&(this.fallbackEl.classList.add("active"),document.documentElement.style.pointerEvents="none",this.fallbackEl.style.pointerEvents="auto")},closeOverlay(){const a=document.getElementById("appBusy");if(a&&(a.style.display="none"),this.dialogEl){try{this.dialogEl.open&&this.dialogEl.close()}catch(i){console.warn(i)}document.body.removeAttribute("aria-busy")}this.fallbackEl&&(this.fallbackEl.classList.remove("active"),document.documentElement.style.pointerEvents="")},scheduleCloseWatchdog(){this.watchdogTimer||(this.watchdogTimer=setTimeout(()=>{this.watchdogTimer=null,this.count===0&&(this.closeOverlay(),queueMicrotask(()=>this.closeOverlay()),requestAnimationFrame(()=>this.closeOverlay()))},0))}};window[t]=n})();const N=window.__APP_BUSY_OVERLAY__;function pn(e="Working…"){N.count+=1,N.count===1?N.openOverlay(e):N.labelEl&&(N.labelEl.textContent=e)}function gn(){N.count>0&&(N.count-=1),N.count<0&&(N.count=0);const e=document.getElementById("appBusy");e&&(e.style.display="none"),N.count===0&&N.scheduleCloseWatchdog()}async function E(e,t="Working…"){pn(t);try{return await e()}finally{gn()}}const yn="toast",hn="toastLayer";let at=0;function vn(){const e=document.getElementById(hn),t=document.getElementById(yn);return!e||!t?{toastDialog:null,toastElement:null}:{toastDialog:e,toastElement:t}}function u(e,t=2e3){const{toastDialog:n,toastElement:a}=vn();!n||!a||(a.textContent=String(e??""),n.open||n.show(),a.classList.add("show"),clearTimeout(at),at=setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{n.open&&n.close()},200)},Number.isFinite(t)?t:2e3))}const P=Object.freeze({required:!0,digitsOnly:!0,maxDigits:4,min:1,max:9999});function le(e,t={}){const{required:n=!0,digitsOnly:a=!0,maxDigits:i=4,min:s=1,max:o=9999}=t,r=String(e??"").trim();if(n&&!r)return"DCC Address is required";if(!n&&!e)return null;if(a&&!/^\d+$/.test(r))return"Use digits only (0-9)";if(i&&r.length>i)return`Max ${i} digits`;const l=Number(r);return Number.isNaN(l)?"DCC Address must be numeric":l<s||l>o?`DCC Address must be between ${s} and ${o}`:null}function bn(e,t,n="fn-error"){let a=document.getElementById(t);return a||(a=document.createElement("div"),a.id=t,a.className=n,a.setAttribute("role","alert"),a.setAttribute("aria-live","polite"),e.insertAdjacentElement("afterend",a)),a}function wn(e,t=4){e&&(e.setAttribute("inputmode","numeric"),e.setAttribute("pattern","\\d*"),e.setAttribute("autocomplete","off"),e.setAttribute("maxlength",String(t)))}function Sn({input:e,errorEl:t,saveButton:n,writeDccButton:a,rules:i={},disableSaveWhenInvalid:s=!0}){if(!e)return!0;const o=le(e.value,i);return t&&(t.textContent=o||""),e.setAttribute("aria-invalid",o?"true":"false"),n&&s&&(n.disabled=!!o,a&&(a.disabled=!!o)),!o}function Te({input:e,saveButton:t,writeDccButton:n,rules:a={},errorId:i="dccAddressError",disableSaveWhenInvalid:s=!0}){if(!e)return()=>{};wn(e,a.maxDigits??4);const o=bn(e,i),r=()=>Sn({input:e,errorEl:o,saveButton:t,writeDccButton:n,rules:a,disableSaveWhenInvalid:s});return r(),e.addEventListener("input",r),()=>e.removeEventListener("input",r)}function gt(e){return String(e).trim().replace(/[^\w.-]+/g,"_").replace(/^_+|_+$/g,"")||"unnamed"}async function En(e="#railroadName"){const t=document.querySelector(e);if(t)try{const n=await Xt();t.textContent=n||"My Railroad"}catch{t.textContent="My Railroad"}}function A(e){return(e??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}async function Ln(){await En()}function c(e,t=document){return t.querySelector(e)}function w(e,t=""){const n=c(e);n&&(n.value=t)}function C(e){var n;const t=c(e);return((n=t==null?void 0:t.value)==null?void 0:n.trim())??""}function Nn(e){const t=c(e);return!!(t!=null&&t.checked)}function yt(e,t=""){const n=c(e);n&&(n.src=t||"")}function Cn(e){const t=(e||"").trim();return t?`/api/roster/icon?id=${encodeURIComponent(t)}&v=${Date.now()}`:""}function An(e=document){e.querySelectorAll('[role="tablist"]').forEach(n=>kn(n))}function kn(e){const t=Array.from(e.querySelectorAll('[role="tab"]'));if(t.length===0)return;t.some(a=>a.getAttribute("aria-selected")==="true")||t[0].setAttribute("aria-selected","true"),ht(t),t.forEach(a=>{a.addEventListener("click",()=>{In(a,t)})})}function In(e,t,n={}){const{focus:a=!1}=n;t.forEach(i=>{i.setAttribute("aria-selected",i===e?"true":"false")}),ht(t),a&&e.focus()}function ht(e){e.map(a=>a.getAttribute("aria-controls")).filter(Boolean).forEach(a=>{const i=document.getElementById(a);i&&(i.hidden=!0)});const n=e.find(a=>a.getAttribute("aria-selected")==="true");if(n){const a=n.getAttribute("aria-controls"),i=a?document.getElementById(a):null;i&&(i.hidden=!1)}}function Oe(e,t=null){if(!e)return;const n=Array.from(e.querySelectorAll('[role="tab"]'));let a=null;t&&(a=n.find(s=>s.getAttribute("aria-controls")===t||s.dataset.panel===t||s.dataset.target===t)||null),a||(a=n[0]||null),a&&$n(e,a);const i=e.querySelector(".modal-body")||e;i.scrollTop=0}function $n(e,t){const n=e.querySelectorAll('[role="tab"]'),a=e.querySelectorAll('[role="tabpanel"]');n.forEach(s=>s.setAttribute("aria-selected","false")),t.setAttribute("aria-selected","true");const i=t.getAttribute("aria-controls")||t.dataset.panel||t.dataset.target||"";a.forEach(s=>{s.hidden=s.id!==i})}async function Dn(e){try{await E(async()=>{var a,i;const t=await on(),n={family:(((a=e==null?void 0:e.dataset)==null?void 0:a.preferredFamily)||"").trim(),model:(((i=e==null?void 0:e.dataset)==null?void 0:i.preferredModel)||"").trim()};Mn(e,t,n)},"Reading DCC Decoder...")}catch(t){u==null||u((t==null?void 0:t.message)||"Failed to read DCC decoder")}}async function Tn(e,t){var l;if(!e||!t)return!1;vt(e,"Read from Loco to find decoder...");let n;try{n=await Jt(t)}catch{return!1}const a=n==null?void 0:n.decoder;if(!a)return!1;a.modelId=(l=n==null?void 0:n.identify)==null?void 0:l.modelId;const i=(a.manufacturer||"").trim(),s=(a.family||"").trim(),o=(a.model||"").trim();if(!i&&!s&&!o)return!1;Bn(e,1);const r=bt({manufacturer:i,family:s,model:o,isVariant:!1,mfgId:a.manufacturerId,mfgName:a.manufacturer,productId:a.productId,modelId:a.modelId,value:"saved"});return e.appendChild(r),r.selected=!0,e.disabled=!1,e.dataset.preferredFamily=s,e.dataset.preferredModel=o,!0}function O(e){return String(e??"").replace(/\s+/g," ").trim()}function it(e,t,n){return[O(e).toLowerCase(),O(t).toLowerCase(),O(n).toLowerCase()].join("|")}function On(e){const t=[],n=new Set,a=Array.isArray(e==null?void 0:e.candidates)?e.candidates:[],i=(e==null?void 0:e.identify)??{};for(let s=0;s<a.length;s++){const o=a[s]||{},r=O(o.manufacturer),l=O(o.family),d=O(o.model),f=it(r,l,d);n.has(f)||(n.add(f),t.push({label:[r,l,d].filter(Boolean).join(" — "),manufacturer:r,family:l,model:d,mfgId:i.mfgId,mfgName:i.mfgName,productId:i.productId,modelId:i.modelId,isVariant:!1}));const h=Array.isArray(o.variants)?o.variants:[];for(let v=0;v<h.length;v++){const b=O(h[v]);if(!b)continue;const p=it(r,l,b);n.has(p)||(n.add(p),t.push({label:[r,l,b].filter(Boolean).join(" — "),manufacturer:r,family:l,model:b,mfgId:i.mfgId,mfgName:i.mfgName,productId:i.productId,modelId:i.modelId,isVariant:!0}))}}return t}function Fn(e){const t=document.createDocumentFragment(),n=document.createElement("option");return n.value="",n.disabled=!0,n.selected=!0,n.textContent=`${e.length} Options Found...`,t.appendChild(n),e.forEach((a,i)=>{const s=bt({...a,value:String(i)});t.appendChild(s)}),t}function Mn(e,t,n){const a=On(t),i=Fn(a);return e.innerHTML="",e.appendChild(i),e.disabled=!1,n&&(n.family||n.model)&&Pn(e,n.family,n.model),a}function xn(e){var o,r,l,d,f;const t=(o=e.selectedOptions)==null?void 0:o[0];if(!t||!t.value)return null;const n=((r=t==null?void 0:t.dataset)==null?void 0:r.mfgId)??void 0,a=((l=t==null?void 0:t.dataset)==null?void 0:l.productId)??void 0,i=((d=t==null?void 0:t.dataset)==null?void 0:d.mfgName)??void 0,s=((f=t==null?void 0:t.dataset)==null?void 0:f.modelId)??void 0;return{family:t.dataset.family||"",model:t.dataset.model||"",manufacturer:t.dataset.manufacturer||"",isVariant:t.dataset.isVariant==="true",mfgId:n,productId:a,mfgName:i,modelId:s}}function vt(e,t){e.innerHTML="";const n=document.createElement("option");n.value="",n.dataset.placeholder="true",n.disabled=!0,n.selected=!0,n.textContent=t,e.appendChild(n),e.disabled=!1}function Bn(e,t){const n=e.querySelector('option[data-placeholder="true"]');n&&(n.textContent=`${t} Options Found...`)}function bt({manufacturer:e="",family:t="",model:n="",isVariant:a=!1,mfgId:i,productId:s,mfgName:o,modelId:r,value:l="opt"}){const d=document.createElement("option");return d.value=l,d.textContent=[e,t,n].filter(Boolean).join(" — ")||"Saved Decoder",d.dataset.manufacturer=e,d.dataset.family=t,d.dataset.model=n,d.dataset.isVariant=String(!!a),i!=null&&(d.dataset.mfgId=String(i)),s!=null&&(d.dataset.productId=String(s)),o!=null&&(d.dataset.mfgName=String(o)),r!=null&&(d.dataset.modelId=String(r)),d}function Pn(e,t,n){const a=(t||"").toLowerCase().trim(),i=(n||"").toLowerCase().trim();for(const s of e.options){if(!s.value)continue;const o=(s.dataset.family||"").toLowerCase(),r=(s.dataset.model||"").toLowerCase();if((!a||o===a)&&(!i||r===i))return s.selected=!0,!0}return!1}function Un(e,t=!1){var h;const n=(e==null?void 0:e.id)||(e==null?void 0:e.title)||"",a=(e==null?void 0:e.address)||"",i=(e==null?void 0:e.road)||"",s=(e==null?void 0:e.number)||"",o=(e==null?void 0:e.model)||"",r=(e==null?void 0:e.owner)||"",l=(e==null?void 0:e.file)||((h=e==null?void 0:e.data)==null?void 0:h.fileName)||"",d=e!=null&&e.imageUrl?`${e.imageUrl}&v=${Date.now()}`:Cn(n);let f="";t?f=(e==null?void 0:e.decoderSelectId)||"":f=n||"",Tn(c(m.decoderSelect),f),t?oe=(e==null?void 0:e.imageUrl)||"":oe=n?`/api/roster/icon?id=${encodeURIComponent(n)}`:(e==null?void 0:e.imageUrl)||"",w(m.id,n),w(m.dcc,a),w(m.road,i),w(m.number,s),w(m.model,o),w(m.owner,r),w(m.file,l),w(m.imageUrl,d),yt(m.imageEl,d)}function qn(){w(m.id,""),w(m.dcc,""),w(m.road,""),w(m.number,""),w(m.model,""),w(m.owner,""),w(m.file,""),w(m.imageUrl,""),yt(m.imageEl,""),vt(c(m.decoderSelect),"Read from Loco to find decoder...")}function wt(){var l,d,f,h,v,b,p,M,k,We,Ve,Ge,Xe,Je,Ke,Ze;const e=((d=(l=c(m.id))==null?void 0:l.value)==null?void 0:d.trim())||"",t=((h=(f=c(m.dcc))==null?void 0:f.value)==null?void 0:h.trim())||"",n=((b=(v=c(m.road))==null?void 0:v.value)==null?void 0:b.trim())||"",a=((M=(p=c(m.number))==null?void 0:p.value)==null?void 0:M.trim())||"",i=((We=(k=c(m.model))==null?void 0:k.value)==null?void 0:We.trim())||"",s=((Ge=(Ve=c(m.owner))==null?void 0:Ve.value)==null?void 0:Ge.trim())||"",o=((Je=(Xe=c(m.file))==null?void 0:Xe.value)==null?void 0:Je.trim())||"",r=((Ze=(Ke=c(m.imageUrl))==null?void 0:Ke.value)==null?void 0:Ze.trim())||"";return{id:e,address:t,road:n,number:a,model:i,owner:s,file:o,imageUrl:r}}let Fe=null,oe="";function jn(){Fe=null,oe=""}function Rn(){const e=c(m.dropZone),t=c(m.fileInput),n=c(m.imageEl);if(!e||!t||!n)return;t.replaceWith(t.cloneNode(!0));const a=c(m.fileInput);e.addEventListener("click",()=>a==null?void 0:a.click()),["dragenter","dragover"].forEach(i=>e.addEventListener(i,s=>{s.preventDefault(),s.stopPropagation(),e.classList.add("drag")})),["dragleave","drop"].forEach(i=>e.addEventListener(i,s=>{s.preventDefault(),s.stopPropagation(),e.classList.remove("drag")})),e.addEventListener("drop",i=>{var o,r;const s=(r=(o=i.dataTransfer)==null?void 0:o.files)==null?void 0:r[0];s&&ot(s,n)}),a.addEventListener("change",()=>{var s;const i=(s=a.files)==null?void 0:s[0];i&&ot(i,n)})}function ot(e,t){Fe=e;const n=URL.createObjectURL(e);t.src=n}function Hn(){return Fe}function _n(){return oe||""}function zn(e){try{return new URL(e,window.location.origin).toString()}catch{return""}}async function Wn(e,t){if(!e)return null;const n=zn(e);if(!n)return null;try{const a=await fetch(n,{credentials:"same-origin"});if(!a.ok)return null;const i=await a.blob(),s=i.type||"image/jpeg",o=s==="image/png"?"png":s==="image/webp"?"webp":s==="image/gif"?"gif":s==="image/svg+xml"?"svg":"jpg",r=(t||"image").replace(/[^\w.-]+/g,"_");return new File([i],`${r}.${o}`,{type:s})}catch{return null}}async function Vn({pickedFile:e,existingSrc:t,rosterId:n}){if(e)return{fileToUpload:e,imageField:void 0};const a=t==null?void 0:t.startsWith("blob:");if(t&&!a){const i=await Wn(t,n);return i?{fileToUpload:i,imageField:void 0}:{fileToUpload:null,imageField:t}}return{fileToUpload:null,imageField:""}}function Gn(){return wt()}async function Xn(){try{await E(async()=>{const e=await nn();if(e!==null&&String(e).trim()!==""){w(m.dcc,String(e).trim());const t=c(m.dcc);t==null||t.dispatchEvent(new Event("input",{bubbles:!0})),u("DCC address read")}else u("No address detected")},"Reading DCC Address...")}catch(e){u((e==null?void 0:e.message)||"Failed to read DCC address")}}async function Jn(){try{await E(async()=>{const e=wt().address;await an(e,{mode:"service"}),u("DCC address written")},"Writing DCC Address...")}catch(e){u((e==null?void 0:e.message)||"Failed to write DCC address")}}const x={list:"#fnList",addButton:"#fnAdd",copySelect:"#fnCopySelect"},U=28;let R="",st=!1,S=[];function B(e,t=document){return t.querySelector(e)}function Kn(e,t,n){return Math.min(n,Math.max(e,t))}function St(){S.sort((e,t)=>Number(e.num)-Number(t.num))}function Zn(){const e=new Set(S.map(t=>Number(t.num)));for(let t=0;t<=U;t+=1)if(!e.has(t))return t;return null}function Yn(e){const t=new Set(S.map(n=>Number(n.num)));if(!t.has(e))return e;for(let n=e+1;n<=U;n+=1)if(!t.has(n))return n;for(let n=0;n<e;n+=1)if(!t.has(n))return n;return null}function Qn(e){return`
    <li class="fn-card" data-fn-num="${e.num}">
      <div class="fn-row">
        <div class="fn-num">
          <input
            type="number"
            class="fn-num-input"
            inputmode="numeric" pattern="\\d*"
            min="0" max="${U}"
            value="${e.num}"
            aria-label="Function number"
          >
        </div>

        <div class="fn-label">
          <input
            type="text"
            class="fn-label-input"
            value="${A(e.label||"")}"
            placeholder="Label (e.g. Horn)"
            aria-label="Function label"
          >
        </div>

        <div class="fn-lock">
          <label class="row row--stack" style="gap:6px">
            <span>Lockable</span>
            <input type="checkbox" class="fn-lock-input" ${e.lockable?"checked":""}>
          </label>
        </div>

        <div class="fn-actions">
          <button
            type="button"
            class="icon-btn fn-delete-btn"
            aria-label="Delete function"
            title="Delete"
            style="padding:4px;border:0;background:transparent;color:#a62622"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
    </li>
  `}function F(){const e=B(x.list);e&&(St(),e.innerHTML=S.map(Qn).join(""))}async function ea(){const e=B(x.copySelect);if(!e)return;e.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="Copy functions from…",e.appendChild(t);let n=[];try{const o=await Ie({fresh:!1});n=Array.isArray(o)?o:[]}catch{return}const i=n.map(o=>{var d,f;const r=o.fileName||o.file||((d=o.data)==null?void 0:d.fileName)||"",l=o.id||o.title||o.name||((f=o.data)==null?void 0:f.name)||"";return{fileName:r,displayId:l}}).filter(o=>o.fileName&&o.displayId).filter(o=>o.fileName!==R),s=await ta(i,4);s.sort((o,r)=>String(o.displayId).localeCompare(String(r.displayId),void 0,{numeric:!0,sensitivity:"base"}));for(const o of s){const r=document.createElement("option");r.value=o.fileName;const l=` (${o.functionCount})`;r.textContent=`${o.displayId}${l}`,e.appendChild(r)}}async function ta(e,t=4){const n=[];let a=0;async function i(){for(;a<e.length;){const o=a++,r=e[o];try{const l=await $e(r.fileName);Array.isArray(l)&&l.length>0&&n.push({fileName:r.fileName,displayId:r.displayId,functionCount:l.length})}catch{}}}const s=Math.max(1,Math.min(t,e.length));return await Promise.all(Array.from({length:s},()=>i())),n}async function na(){const e=B(x.copySelect);if(!e)return;const t=e.value;if(t&&!(S.length>0&&!window.confirm("Replace current functions with those from the selected loco?")))try{const n=await $e(t);S=(Array.isArray(n)?n:[]).map(i=>({num:Number(i.num),label:i.label??"",lockable:!!i.lockable})).filter(i=>Number.isFinite(i.num)&&i.num>=0&&i.num<=U),F(),u==null||u("Functions copied")}catch(n){u==null||u((n==null?void 0:n.message)||"Failed to copy functions")}}function aa(){const e=Zn();if(e===null){u==null||u("All function numbers (0-28) are already used");return}S.push({num:e,label:"",lockable:!1}),F()}function ia(e){const t=Number(e.dataset.fnNum);S=S.filter(n=>Number(n.num)!==t),F()}function oa(e,t){const n=Number(e.dataset.fnNum),a=S.findIndex(d=>Number(d.num)===n);if(a<0)return;const i=S[a],s=Number(t.value);if(!Number.isFinite(s)){t.value=String(i.num);return}const o=Kn(0,s,U),r=i.num;i.num="__TEMP__";const l=Yn(o);if(i.num=r,l===null){t.value=String(r),u==null||u("No free function numbers available (0-28)");return}i.num=l,e.dataset.fnNum=String(l),t.value=String(l),F()}function sa(e,t){const n=Number(e.dataset.fnNum),a=S.find(i=>Number(i.num)===n);a&&(a.label=t.value.trim())}function ra(e,t){const n=Number(e.dataset.fnNum),a=S.find(i=>Number(i.num)===n);a&&(a.lockable=!!t.checked)}function la(e){const t=e.target.closest(".fn-card");t&&e.target.closest(".fn-delete-btn")&&ia(t)}function ca(e){const t=e.target.closest(".fn-card");if(t){if(e.target.classList.contains("fn-num-input")){oa(t,e.target);return}if(e.target.classList.contains("fn-label-input")){sa(t,e.target);return}e.target.classList.contains("fn-lock-input")&&ra(t,e.target)}}function ua(){na()}function da(){if(st)return;st=!0;const e=B(x.list),t=B(x.addButton),n=B(x.copySelect);t==null||t.addEventListener("click",aa),e==null||e.addEventListener("click",la),e==null||e.addEventListener("change",ca),n==null||n.addEventListener("change",ua)}async function ma(e){var t;if(da(),S=[],R=(e==null?void 0:e.file)||((t=e==null?void 0:e.data)==null?void 0:t.fileName)||"",await ea(),!R){F();return}try{const n=await $e(R);S=(Array.isArray(n)?n:[]).map(a=>({num:Number(a.num),label:a.label??"",lockable:!!a.lockable})).filter(a=>Number.isFinite(a.num)&&a.num>=0&&a.num<=U),F()}catch(n){S=[],F(),u==null||u((n==null?void 0:n.message)||"Failed to load functions")}}async function fa(e){const t=(e==null?void 0:e.file)||R||"";if(!t)return;St();const n=S.map(a=>({num:Number(a.num),label:a.label||"",lockable:!!a.lockable}));await tn(t,n)}let me=null;const m={dialog:"#locoDialog",title:"#locoDialogTitle",id:"#locoId",dcc:"#locoDccAddress",road:"#locoRoadName",number:"#locoNumber",model:"#locoModel",owner:"#locoOwner",file:"#locoFile",imageUrl:"#locoImageUrl",decoderSelect:"#locoDecoderSelect",imageEl:"#modalRosterImage",dropZone:"#modalImageDrop",fileInput:"#modalImageInput",save:"#locoSave",cancel:"#locoCancel",close:"#locoClose",delete:"#locoDelete",readDcc:"#locoReadAddress",writeDcc:"#locoWriteAddress",readDccChip:"#locoDecoderRead"};function pa(e){const t=c(m.title);t&&(t.textContent=e==="create"?"Add Locomotive":"Edit Locomotive")}function ga(e){const t=c(m.id);t&&t.toggleAttribute("readonly",e==="edit")}function D(e){const t=c(e);if(!t)return null;const n=t.cloneNode(!0);return t.replaceWith(n),n}function ya(e){e&&!e.open&&e.showModal()}function Me(){const e=c(m.dialog);try{e!=null&&e.open&&e.close()}catch(t){console.warn(t)}jn()}async function se(e,t,n,a=!1){const i=c(m.dialog);if(!i)return;pa(e),ga(e),t?Un(t,a):qn(),An(i),Rn();const s=D(m.save),o=D(m.cancel),r=D(m.close),l=D(m.delete),d=D(m.readDcc),f=D(m.writeDcc),h=D(m.readDccChip);s==null||s.addEventListener("click",()=>va(n));const v=()=>Me();o==null||o.addEventListener("click",v),r==null||r.addEventListener("click",v),l==null||l.addEventListener("click",()=>ba(n)),d==null||d.addEventListener("click",Xn),f==null||f.addEventListener("click",Jn),h==null||h.addEventListener("click",()=>Dn(c(m.decoderSelect))),e==="edit"?l.hidden=!1:l.hidden=!0;const b=c(m.dcc);me&&me(),me=Te({input:b,saveButton:c(m.save),writeDccButton:c(m.writeDcc),rules:P,errorId:"rosterSystemNameError",disableSaveWhenInvalid:!0});try{await ma(t)}catch(p){console.warn(p)}ya(i),Oe(i)}let Y=null;async function xe(){const e=await Ie({fresh:!0});return Array.isArray(e)?e.map(ha).filter(Boolean):[]}function ha(e){if(!e||typeof e!="object")return null;const t=T(e.id),n=T(e.fileName),a=T(e.address),i=T(e.road),s=T(e.number),o=T(e.model),r=T(e.owner),l=t?`/api/roster/icon?id=${encodeURIComponent(t)}`:"";return{title:t,address:a,road:i,number:s,model:o,owner:r,imageUrl:l,id:t,file:n,data:e}}function T(e){return e===null?"":String(e)}async function va(e){const t=Gn();if(!t.id){u("ID is required");return}const n=le(t.address,P);if(n){u==null||u(n);return}try{await E(async()=>{let a=t.file;const{fileToUpload:i,imageField:s}=await Vn({pickedFile:Hn(),existingSrc:_n(),rosterId:t.id}),o=t.file||`${gt(t.id)}.xml`,r={...t,file:o,...typeof s<"u"?{image:s}:{}};await Zt(r.file,r),a=await Gt(t.file),a&&w(m.file,a),i&&await Qt(r.id,i);const l=c(m.decoderSelect),d=xn(l);d&&await Yt(r.id,d),await fa(r)},"Saving…"),Me(),u("Saved"),e==null||e()}catch(a){u((a==null?void 0:a.message)||"Save failed")}}async function ba(e){const t=C(m.file);if(!t){u("Missing file to delete");return}try{await E(async()=>{await Kt(t)},"Deleting…"),Me(),u("Deleted"),e==null||e()}catch(n){u((n==null?void 0:n.message)||"Delete failed")}}function wa(){if(Y)return Y;const e=document.createElement("input");return e.type="file",e.accept=".xml,application/xml,text/xml",e.hidden=!0,document.body.appendChild(e),e.addEventListener("change",async()=>{var r;const t=(r=e.files)==null?void 0:r[0];if(e.value="",!t)return;if(!(t.type==="application/xml"||t.type==="text/xml"||/\.xml$/i.test(t.name))){u("Please select an XML file");return}const i=(t.name||"unnamed.xml").replace(/\.[^.]+$/g,""),o=`${gt(i)}.xml`;try{await E(async()=>{await en(t,o),u("XML uploaded"),await xe(),_()},"Uploading XML…")}catch(l){u((l==null?void 0:l.message)||"Upload failed")}}),Y=e,Y}function Sa(){wa().click()}function Ea(e,t={}){var o;const n=document.createElement("article");n.className="card",n.dataset.rosterId=e.id;const a=e.title||"(unnamed)",i=Ca([e.address&&`DCC ${e.address}`,Na(e.road,e.number),e.model,e.owner&&`Owner: ${e.owner}`]);n.innerHTML=`
    <div class="card-img" aria-hidden="true">
      ${La(e.imageUrl)}
    </div>
    <div class="card-body">
      <div class="card-title">${A(a)}</div>
      ${i.map(r=>`<div class="card-sub">${A(r)}</div>`).join("")}
    </div>
  `;const s=()=>{var r;return(r=t.onEdit)==null?void 0:r.call(t,e)};return n.addEventListener("click",s),(o=n.querySelector('[data-act="edit"]'))==null||o.addEventListener("click",r=>{r.stopPropagation(),s()}),n}function La(e){const t=(e||"").trim();return t?`<img class="card-img-media" src="${Aa(t)}&v=${Date.now()}" alt="" loading="lazy" decoding="async" data-roster-img="">`:'<span class="card-img-placeholder" aria-hidden="true"></span>'}function Na(e,t){const n=(e||"").trim(),a=(t||"").trim();return!n&&!a?"":n&&a?`${n} ${a}`:n||a}function Ca(e){return(e||[]).filter(Boolean)}function Aa(e){return String(e).replace(/"/g,"&quot;")}const fe=Object.freeze({panel:"#panelRoster",list:"#rosterList",addButton:"#addBtn"});function Be(e=document){return{panelElement:e.querySelector(fe.panel),listElement:e.querySelector(fe.list),addButton:e.querySelector(fe.addButton)}}function ka(e){return`/api/roster/icon?id=${encodeURIComponent(e)}&v=${Date.now()}`}function Ia(e,t){if(!e)return;const n=Ae(t),i={id:ke(e.id,e.address,n,!0),address:e.address||"",road:e.road||"",number:e.number||"",model:e.model||"",owner:e.owner||"",file:"",imageUrl:e.imageUrl||"",decoderSelectId:e.id||""};se("create",i,()=>_(),!0)}const L={root:null,anchor:null,records:[],filtered:[]};function $a(){if(L.root)return L.root;const e=document.createElement("div");e.className="copy-entryItem",e.hidden=!0;const t=document.createElement("div");t.className="copy-popover",t.role="tabpanel",t.hidden=!0,t.innerHTML=`
    <div class="copy-head">
      <input class="copy-search" type="search" placeholder="Search by ID, road, number, model, owner" aria-label="Search locos">
      <button class="copy-close" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="copy-list" role="listbox" aria-label="Locos"></div>
  `,document.body.appendChild(e),document.body.appendChild(t);const n=t.querySelector(".copy-search"),a=t.querySelector(".copy-list"),i=t.querySelector(".copy-close");L.root={entryItem:e,copyPopup:t,search:n,listContainer:a,closeButton:i};const s=()=>{e.hidden=!0,t.hidden=!0,t.removeAttribute("style"),L.anchor=null};return e.addEventListener("click",s),i==null||i.addEventListener("click",s),n.addEventListener("input",()=>{Lt(Et(L.records,n.value))}),L.root}function Et(e,t){const n=String(t||"").trim().toLowerCase();return n?(e||[]).filter(a=>[a.id,a.road,a.number,a.model,a.owner].some(i=>(i||"").toLowerCase().includes(n))).slice(0,200):(e||[]).slice(0,200)}function Lt(e){const{listContainer:t}=L.root;if(L.filtered=e,t.innerHTML="",!e.length){t.innerHTML='<div class="copy-item copy-item-no-results" aria-disabled="true">No matches</div>';return}e.forEach(n=>{const a=document.createElement("div");a.className="copy-item",a.setAttribute("role","option"),a.innerHTML=`
      <div class="copy-thumb"><img alt="" src="${ka(n.id)}"></div>
      <div class="copy-main">
        <div class="copy-title">${A(n.id)}</div>
        <div class="copy-sub">${A([n.road,n.number,n.model,n.owner].filter(Boolean).join(" | "))}</div>
      </div>
    `,a.addEventListener("click",i=>{(i.target.closest(".copy-choose")||i.currentTarget===a)&&Da(n)}),a.addEventListener("mouseenter",()=>{a.focus({preventScroll:!0})}),t.appendChild(a)})}function Da(e){const{entryItem:t,copyPopup:n}=L.root;t.hidden=!0,n.hidden=!0,n.removeAttribute("style"),L.anchor=null,Ia(e,L.records)}function Ta(e,t){const a=e.getBoundingClientRect().bottom+8;t.style.top=`${a}px`,t.style.right="10px"}async function Oa(e){const t=$a();L.anchor=e||document.getElementById("addLocoMore");try{const n=await xe();L.records=n||[]}catch(n){u((n==null?void 0:n.message)||"Failed to load roster");return}t.entryItem.hidden=!1,t.copyPopup.hidden=!1,Lt(Et(L.records,"")),Ta(L.anchor,t.copyPopup),t.search.value="",t.search.focus({preventScroll:!0})}const Fa="roster",Ma="Loading roster…",Le={initialized:!1,items:[]};function xa(){const{listElement:e}=Be();return e||null}function Nt(e){const t=xa();t&&(t.innerHTML="",(e||[]).forEach(n=>{const a=Ea(n,{onEdit:()=>se("edit",n,()=>_())});t.appendChild(a)}),(!e||e.length===0)&&(t.innerHTML=`
      <div class="empty">
        <div class="empty-title">No locomotives yet</div>
        <div class="empty-subtitle">Add a locomotive to get started.</div>
      </div>
    `))}async function Ct(){const e=await xe();Le.items=e,Nt(e)}async function At(){if(!Le.initialized){Le.initialized=!0,Nt([]);try{await E(Ct,Ma)}catch{}}}async function _(){try{await E(Ct,"Refreshing…")}catch{u("Refresh failed")}}function Ba(e){var t;((t=e==null?void 0:e.detail)==null?void 0:t.name)===Fa&&At()}function Pa(){const{addButton:e}=Be(),t=document.getElementById("addLocoMore"),n=document.getElementById("addLocoMenu");if(!t||!n||!e)return;e.addEventListener("click",()=>{se("create",null,()=>_(),!1)});const a=()=>{n.hidden=!1,t.setAttribute("aria-expanded","true"),document.addEventListener("click",s,{capture:!0})},i=()=>{n.hidden=!0,t.setAttribute("aria-expanded","false"),document.removeEventListener("click",s,{capture:!0})},s=o=>{n.contains(o.target)||t.contains(o.target)||i()};t.addEventListener("click",o=>{o.stopPropagation(),n.hidden?a():i()}),n.addEventListener("click",o=>{const r=o.target.closest(".menu-item");if(!r)return;const l=r.dataset.action;i(),l==="manual"&&se("create",null,()=>_(),!1),l==="copy"&&Oa(document.getElementById("addLocoMore")),l==="upload"&&Sa()})}function Ua(){document.addEventListener("panel:changed",Ba),Pa();const{panelElement:e}=Be();e&&!e.hasAttribute("hidden")&&At()}const kt=Object.freeze({panel:"#panelSettings",connectionsSelect:"#jmriConnectionSelect"}),qa="settings",ja="Loading settings…";async function Ra(){document.addEventListener("panel:changed",Ha);const e=c(kt.connectionsSelect);e&&e.addEventListener("change",za)}async function Ha(e){var t;if(((t=e==null?void 0:e.detail)==null?void 0:t.name)===qa)try{await E(async()=>{await _a()},ja)}catch{}}async function _a(){const e=await ft();pt(e);const t=c(kt.connectionsSelect);if(t){t.innerHTML="";for(const n of e){const a=document.createElement("option");a.value=n.systemPrefix,a.textContent=n.userName,n.systemPrefix===(Q==null?void 0:Q.systemPrefix)&&(a.selected=!0),t.appendChild(a)}}}async function za(e){var n;const t=((n=e==null?void 0:e.target)==null?void 0:n.value)||"I";await un(t)}function Wa(e){let t=null;return Array.isArray(e)?t=e:e&&typeof e=="object"&&(Array.isArray(e.data)?t=e.data:Array.isArray(e.turnouts)?t=e.turnouts:Array.isArray(e.list)?t=e.list:Array.isArray(e.items)?t=e.items:t=Object.values(e)),(t||[]).map(Pe).filter(Boolean)}function Pe(e){if(!e)return null;const t=(e.data&&typeof e.data=="object"?e.data:e)||{},n=t.name||"",a=t.userName||"",i=t.comment||"",s=!!t.inverted,o=t.state;let r="Unknown",l=!1,d=!1,f=!0;return o===4&&!s||o===2&&s?(r="Thrown",l=!0,f=!1):(o===2&&!s||o===4&&s)&&(r="Closed",d=!0,f=!1),{title:a,address:n,comment:i,state:o,normalisedState:r,isThrown:l,isClosed:d,isUnknown:f,inverted:s,name:n,userName:a,data:t}}async function It(e){const t=String(e.systemName||"").trim();if(!t)throw new Error("System Name is required");const n={name:t,...e.userName!=null?{userName:e.userName}:{},...e.comment!=null?{comment:e.comment}:{},...e.inverted!=null?{inverted:!!e.inverted}:{}},a=`/json/turnout/${encodeURIComponent(t)}`,i=await $("PUT",a,n),o=Object.prototype.hasOwnProperty.call(n,"userName")||Object.prototype.hasOwnProperty.call(n,"comment")||Object.prototype.hasOwnProperty.call(n,"inverted")?await $("POST",a,n):i;return await De(H),Pe(o)}async function ce(e,t){const n=String(e||"").trim();if(!n)throw new Error("System Name is required");const a={name:n,...t.userName!=null?{userName:t.userName}:{},...t.comment!=null?{comment:t.comment}:{},...t.inverted!=null?{inverted:!!t.inverted}:{},...t.state!=null?{state:t.state}:{}},i=await $("POST",`/json/turnout/${encodeURIComponent(n)}`,a);return Pe(i)}async function Va(e){const t=String(e||"").trim();if(!t)throw new Error("System Name is required");await $("DELETE",`/json/turnout/${encodeURIComponent(t)}`)}const ee=Object.freeze({panel:"#panelTurnouts",list:"#turnoutsList",addButton:"#turnoutsAddBtn"});function $t(e=document){const t=n=>e.querySelector(n);return{panelElement:t(ee.panel),listElement:t(ee.list),addButtonElement:t(ee.addButton)}}function Ga({isThrown:e=!1,isUnknown:t=!1}){return`
<svg class="turnout-icon ${t?"unknown":e?"thrown":"closed"}" viewBox="0 0 64 40" width="64" height="40" aria-hidden="true">
  <g fill="none" stroke-width="4" stroke-linecap="round">
    <!-- straight route -->
    <path class="trk base"    d="M4 20 H60" />
    <!-- diverging route -->
    <path class="trk diverge" d="M4 20 Q30 4 60 4" />
  </g>
  ${t?`
    <g class="badge" aria-hidden="true">
      <!-- question mark -->
      <text class="badge-text" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" x="32" font-size="48" y="35">?</text>
    </g>`:""}
</svg>`}function Xa(e,t={}){var o;const n=document.createElement("article");n.className="card";const a=e.title||"(unnamed)",i=[];e.address&&i.push(e.address),(e.normalisedState||e.normalizedState)&&i.push(e.normalisedState||e.normalizedState);const s=i.join(" · ");return n.innerHTML=`
    <div class="card-img" aria-hidden="true" data-act="toggle">
      ${Ga(e)}
    </div>
    <div class="card-body card-body-turnout">
      <div class="card-title">${A(a)}</div>
      <div class="card-sub">${A(s)}</div>
      ${e.comment?`<div class="card-sub">${A(e.comment)}</div>`:""}
    </div>
  `,(o=n.querySelector('[data-act="toggle"]'))==null||o.addEventListener("click",r=>{var l;r.stopPropagation(),(l=t.onToggle)==null||l.call(t,e)}),n.addEventListener("click",r=>{var l;r.stopPropagation(),(l=t.onEdit)==null||l.call(t,e)}),n}const pe=new Map;async function Dt(e="turnout"){const t=String(e);if(pe.has(t))return pe.get(t);const n=await fetch(`/api/jmri/prefix?type=${encodeURIComponent(e)}`,{headers:{Accept:"application/json"}});if(!n.ok)throw new Error(`Prefix fetch failed: ${n.status}`);const a=await n.json();return pe.set(t,a),a}const g={dialog:"#turnoutDialog",form:"#turnoutForm",title:"#turnoutDialogTitle",prefix:"#toPrefixSelect",system:"#toSystemName",user:"#toUserName",comment:"#toComment",inverted:"#toInverted",state:"#toState",save:"#turnoutSave",cancel:"#turnoutCancel",close:"#turnoutClose",delete:"#turnoutDelete",countRow:"#toCountRow",count:"#toCount"},Ja="Saving…";let te=null,Tt="edit",Ot=[],ge=null,ye=null,q=null,he=null;async function Ka(){const e=c(g.prefix);if(!e)return[];const t=await Dt("turnout");Ot=Array.isArray(t)?t.map(n=>n.systemNamePrefix).filter(Boolean):[],e.innerHTML="";for(const n of t){const a=document.createElement("option");a.value=n.systemNamePrefix,a.textContent=n.connectionName?`${n.systemNamePrefix} — ${n.connectionName}`:n.systemNamePrefix,e.appendChild(a)}return t}function Za(e){if(!e)return null;for(const t of Ot)if(e.startsWith(t))return t;return null}function Ya(e,t){const n=(e||"").trim();if(!n)return"";let a=n;t&&n.startsWith(t)?a=n.slice(t.length):a=n.replace(/^[A-Za-z]+/,"");const i=a.match(/\d+/);return i?i[0]:""}function ve(e,t=null){var l;const n=c(g.system),a=c(g.user),i=c(g.comment),s=c(g.inverted),o=c(g.state),r=(e==null?void 0:e.name)||(e==null?void 0:e.address)||((l=e==null?void 0:e.data)==null?void 0:l.name)||"";n.value=Ya(r,t),a.value=(e==null?void 0:e.userName)||(e==null?void 0:e.title)||"",i.value=(e==null?void 0:e.comment)||"",s.checked=!!(e!=null&&e.inverted),o.value=""}function Qa(){return{dccDigits:C(g.system),selectedPrefix:C(g.prefix),userName:C(g.user),comment:C(g.comment),inverted:Nn(g.inverted),stateChoice:C(g.state)}}function ei(e,t){return e?e==="thrown"?t?2:4:t?4:2:null}function ti(){var t;const e=Number(((t=c(g.count))==null?void 0:t.value)??1);return Number.isFinite(e)&&e>0?Math.min(e,64):1}function ni(e){const t=c(g.countRow);t&&(t.hidden=!e)}function ai(e){const t=c(g.title);t&&(t.textContent=e)}function ii(){const e=c(g.dialog);e&&!e.open&&e.showModal(),Oe(e)}function Ue(){const e=c(g.dialog);if(e)try{e.open&&e.close()}catch(t){console.warn(t)}}async function oi(e){const t=Qa(),n=["create","sequential"].includes(Tt),a=n?si(t):null;if(a){u==null||u(a);return}const i=ri(e,t,n),s=li(t),o=n?ti():1;try{let r="Saved";await E(async()=>{if(n&&o>1)r=await mi(t,o,s);else if(n)await ui(i,t,s);else{const l=ci(e,i);await di(l,t,s)}},Ja),Ue(),u==null||u(r),te==null||te()}catch(r){u==null||u((r==null?void 0:r.message)||"Save failed")}}function si(e){const t=le(e.dccDigits,P);return t||(e.selectedPrefix?null:"Select a connection/prefix")}function ri(e,t,n){var a;return n?`${t.selectedPrefix||""}${t.dccDigits||""}`.trim():((e==null?void 0:e.name)||(e==null?void 0:e.address)||((a=e==null?void 0:e.data)==null?void 0:a.name)||"").trim()}function li(e){return ei(e.stateChoice,e.inverted)}function ci(e,t){var n;return(e==null?void 0:e.name)||(e==null?void 0:e.address)||((n=e==null?void 0:e.data)==null?void 0:n.name)||t}async function ui(e,t,n){const a=(t.userName||"").trim()||String(t.dccDigits||"");await It({systemName:e,userName:a,comment:t.comment,inverted:t.inverted}),n!==null&&await ce(e,{state:n})}async function di(e,t,n){const a={userName:t.userName,comment:t.comment,inverted:t.inverted};n!==null&&(a.state=n),await ce(e,a)}async function mi(e,t,n){const a=Number(e.dccDigits);if(!Number.isFinite(a))throw new Error("Invalid base DCC address");const i=e.selectedPrefix||"";if(!i)throw new Error("Select a connection/prefix");let s=0;const o=[];for(let l=0;l<t;l++){const d=a+l,f=`${i}${d}`,h=await J(),v=Ae(h),b=ke(e.userName,d,v,l===0);try{await It({systemName:f,userName:b,comment:e.comment,inverted:e.inverted}),n!==null&&await ce(f,{state:n}),s+=1}catch(p){o.push({dcc:d,message:(p==null?void 0:p.message)||"create failed"})}}if(o.length===0)return`Created ${s} turnouts`;if(s===0)return`No turnouts created (${o.length} failed)`;const r=o.slice(0,3).map(l=>l.dcc).join(", ");return`Created ${s}/${t}; failed: ${o.length} (${r}${o.length>3?"…":""})`}async function qe(e,t,n){var s,o,r,l,d,f,h,v,b;Tt=e,te=n||null,ai(["create","sequential"].includes(e)?"Add Turnout":"Edit Turnout"),ni(e==="sequential");const a=c(g.count);a&&(a.value="1");try{await Ka();const p=c(g.prefix);if(e==="edit"){const M=(t==null?void 0:t.name)||(t==null?void 0:t.address)||((s=t==null?void 0:t.data)==null?void 0:s.name)||"",k=Za(M);p&&k&&(p.value=k),c(g.delete).hidden=!1,ve(t,k)}else p&&p.options.length>0&&!p.value&&(p.value=p.options[0].value),c(g.delete).hidden=!0,ve(null,null)}catch{ve(e==="edit"?t:null,null)}const i=c(g.system);i&&i.toggleAttribute("readonly",e==="edit"),ge&&ge(),ge=Te({input:i,saveButton:c(g.save),rules:P,errorId:"turnoutSystemNameError",disableSaveWhenInvalid:!0}),ii(),(o=c(g.save))==null||o.removeEventListener("click",ye),(r=c(g.delete))==null||r.removeEventListener("click",he),(l=c(g.cancel))==null||l.removeEventListener("click",q),(d=c(g.close))==null||d.removeEventListener("click",q),ye=()=>oi(t),he=()=>xt(t),q=()=>Ue(),(f=c(g.delete))==null||f.addEventListener("click",he),(h=c(g.save))==null||h.addEventListener("click",ye),(v=c(g.cancel))==null||v.addEventListener("click",q),(b=c(g.close))==null||b.addEventListener("click",q)}const fi="turnouts",Ft="Loading turnouts…",pi="Deleting…",Ne={initialized:!1,items:[]};function rt(e){try{u==null||u(e)}catch(t){console.warn(t)}}async function J(){const e=await sn(),t=Wa(e);return Ne.items=t,t}function z(e){const t=c(ee.list);if(t&&(t.innerHTML="",(e||[]).forEach(n=>{const a=Xa(n,{onToggle:()=>Si(n),onEdit:()=>hi(n),onDelete:()=>xt(n)});t.appendChild(a)}),!e||e.length===0)){const n=document.createElement("div");n.className="empty",n.innerHTML=`
      <div class="empty-title">No turnouts yet</div>
      <div class="empty-subtitle">Add a turnout to get started.</div>
    `,t.appendChild(n)}}async function Mt(){if(!Ne.initialized){Ne.initialized=!0,z([]);try{await E(async()=>{const e=await J();z(e)},Ft)}catch{}}}function gi(e){var t;((t=e==null?void 0:e.detail)==null?void 0:t.name)===fi&&Mt()}function je(){return E(async()=>{const e=await J();z(e)},Ft)}function lt(){qe("create",null,()=>{je()})}function yi(){qe("sequential",null,()=>{je()})}function hi(e){qe("edit",e,()=>{je()})}async function xt(e){var a;const t=e.name||e.address||((a=e.data)==null?void 0:a.name);if(!(!t||!confirm(`Delete turnout "${e.title||t}"?
This cannot be undone.`)))try{await E(async()=>{await Va(t);const i=await J();z(i)},pi),rt("Turnout deleted")}catch{rt("Delete failed")}finally{Ue()}}function vi(){document.addEventListener("panel:changed",gi),bi();const{panelElement:e}=$t();e&&!e.hasAttribute("hidden")&&Mt()}function bi(){const{addButtonElement:e}=$t(),t=document.getElementById("addTurnoutMore"),n=document.getElementById("addTurnoutMenu");if(!t||!n||!e)return;e.addEventListener("click",()=>{lt()});const a=()=>{n.hidden=!1,t.setAttribute("aria-expanded","true"),document.addEventListener("click",s,{capture:!0})},i=()=>{n.hidden=!0,t.setAttribute("aria-expanded","false"),document.removeEventListener("click",s,{capture:!0})},s=o=>{n.contains(o.target)||t.contains(o.target)||i()};t.addEventListener("click",o=>{o.stopPropagation(),n.hidden?a():i()}),n.addEventListener("click",o=>{const r=o.target.closest(".menu-item");if(!r)return;const l=r.dataset.action;i(),l==="single"&&lt(),l==="sequential"&&yi()})}function wi(e,t){return e?t?2:4:t?4:2}async function Si(e){var o;const t=e.name||e.address||((o=e.data)==null?void 0:o.name);if(!t)return;const n=!!e.isThrown,i=!!e.isClosed?!0:!n,s=wi(i,!!e.inverted);try{await ce(t,{state:s});const r=await J();z(r);try{u==null||u(`Turnout ${i?"Thrown":"Closed"}`)}catch(l){console.warn(l)}}catch{try{u==null||u("Toggle failed")}catch(r){console.warn(r)}}}function Ei(e){let t=null;return Array.isArray(e)?t=e:e&&typeof e=="object"&&(Array.isArray(e.data)?t=e.data:Array.isArray(e.lights)?t=e.lights:Array.isArray(e.list)?t=e.list:Array.isArray(e.items)?t=e.items:t=Object.values(e)),(t||[]).map(Re).filter(Boolean)}function Re(e){if(!e)return null;const t=(e.data&&typeof e.data=="object"?e.data:e)||{},n=t.name||"",a=t.userName||"",i=t.comment||"",s=t.state;let o="Unknown",r=!1,l=!1,d=!0;return s===4?(o="Off",r=!0,d=!1):s===2&&(o="On",l=!0,d=!1),{title:a,address:n,comment:i,state:s,normalisedState:o,isOff:r,isOn:l,isUnknown:d,name:n,userName:a,data:t}}async function Bt(e){const t=String(e.systemName||"").trim();if(!t)throw new Error("System Name is required");const n={name:t,...e.userName!=null?{userName:e.userName}:{},...e.comment!=null?{comment:e.comment}:{}},a=`/json/light/${encodeURIComponent(t)}`,i=await $("PUT",a,n),o=Object.prototype.hasOwnProperty.call(n,"userName")||Object.prototype.hasOwnProperty.call(n,"comment")?await $("POST",a,n):i;return await De(H),Re(o)}async function ue(e,t){const n=String(e||"").trim();if(!n)throw new Error("System Name is required");const a={name:n,...t.userName!=null?{userName:t.userName}:{},...t.comment!=null?{comment:t.comment}:{},...t.state!=null?{state:t.state}:{}},i=await $("POST",`/json/light/${encodeURIComponent(n)}`,a);return Re(i)}async function Li(e){const t=String(e||"").trim();if(!t)throw new Error("System Name is required");await $("DELETE",`/api/lights/${encodeURIComponent(t)}`)}const ne=Object.freeze({panel:"#panelLights",list:"#lightsList",addButton:"#lightsAddBtn"});function Pt(e=document){const t=n=>e.querySelector(n);return{panelElement:t(ne.panel),listElement:t(ne.list),addButtonElement:t(ne.addButton)}}function Ni({isOff:e=!1,isUnknown:t=!1}){return`
  <svg class="light-icon ${t?"unknown":e?"off":"on"}" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <g class="off-state">
    <path d="M9 18H15" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M10 21H14" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M16.4999 11.5C17.4997 10.5 17.9765 9.48689 17.9999 8C18.0479 4.95029 16 3 11.9999 3C10.8324 3 9.83119 3.16613 8.99988 3.47724" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M8.99985 15C9 13 8.5 12.5 7.49985 11.5C6.4997 10.5 6.02324 9.48689 5.99985 8C5.99142 7.46458 6.0476 6.96304 6.1676 6.5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path class="active-outline" d="M3 3L21 21" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  </g>
  <g class="on-state">
    <path class="active-outline" d="M9 18H15" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path class="active-outline" d="M10 21H14" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path class="active-outline" d="M9.00082 15C9.00098 13 8.50098 12.5 7.50082 11.5C6.50067 10.5 6.02422 9.48689 6.00082 8C5.95284 4.95029 8.00067 3 12.0008 3C16.001 3 18.0488 4.95029 18.0008 8C17.9774 9.48689 17.5007 10.5 16.5008 11.5C15.501 12.5 15.001 13 15.0008 15" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  </g>
  ${t?`
    <g class="badge" aria-hidden="true">
      <!-- question mark -->
      <text class="badge-text" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" x="32" font-size="48" y="35">?</text>
    </g>`:""}
  </svg>`}function Ci(e,t={}){var o;const n=document.createElement("article");n.className="card";const a=e.title||"(unnamed)",i=[];e.address&&i.push(e.address),(e.normalisedState||e.normalizedState)&&i.push(e.normalisedState||e.normalizedState);const s=i.join(" · ");return n.innerHTML=`
    <div class="card-img" aria-hidden="true" data-act="toggle">
      ${Ni(e)}
    </div>
    <div class="card-body card-body-light">
      <div class="card-title">${A(a)}</div>
      <div class="card-sub">${A(s)}</div>
      ${e.comment?`<div class="card-sub">${A(e.comment)}</div>`:""}
    </div>
  `,(o=n.querySelector('[data-act="toggle"]'))==null||o.addEventListener("click",r=>{var l;r.stopPropagation(),(l=t.onToggle)==null||l.call(t,e)}),n.addEventListener("click",r=>{var l;r.stopPropagation(),(l=t.onEdit)==null||l.call(t,e)}),n}const y={dialog:"#lightDialog",form:"#lightForm",title:"#lightDialogTitle",prefix:"#toLightPrefixSelect",system:"#toLightSystemName",user:"#toLightUserName",comment:"#toLightComment",state:"#toLightState",save:"#lightSave",cancel:"#lightCancel",close:"#lightClose",delete:"#lightDelete",countRow:"#toLightCountRow",count:"#toLightCount"},Ai="Saving…";let ae=null,Ut="edit",qt=[],be=null,we=null,j=null,Se=null;async function ki(){const e=c(y.prefix);if(!e)return[];const t=await Dt("light");qt=Array.isArray(t)?t.map(n=>n.systemNamePrefix).filter(Boolean):[],e.innerHTML="";for(const n of t){const a=document.createElement("option");a.value=n.systemNamePrefix,a.textContent=n.connectionName?`${n.systemNamePrefix} — ${n.connectionName}`:n.systemNamePrefix,e.appendChild(a)}return t}function Ii(e){if(!e)return null;for(const t of qt)if(e.startsWith(t))return t;return null}function $i(e,t){const n=(e||"").trim();if(!n)return"";let a=n;t&&n.startsWith(t)?a=n.slice(t.length):a=n.replace(/^[A-Za-z]+/,"");const i=a.match(/\d+/);return i?i[0]:""}function Ee(e,t=null){var r;const n=c(y.system),a=c(y.user),i=c(y.comment),s=c(y.state),o=(e==null?void 0:e.name)||(e==null?void 0:e.address)||((r=e==null?void 0:e.data)==null?void 0:r.name)||"";n.value=$i(o,t),a.value=(e==null?void 0:e.userName)||(e==null?void 0:e.title)||"",i.value=(e==null?void 0:e.comment)||"",s.value=""}function Di(){return{dccDigits:C(y.system),selectedPrefix:C(y.prefix),userName:C(y.user),comment:C(y.comment),stateChoice:C(y.state)}}function Ti(e){return e?e==="on"?2:4:null}function Oi(){var t;const e=Number(((t=c(y.count))==null?void 0:t.value)??1);return Number.isFinite(e)&&e>0?Math.min(e,64):1}function Fi(e){const t=c(y.countRow);t&&(t.hidden=!e)}function Mi(e){const t=c(y.title);t&&(t.textContent=e)}function xi(){const e=c(y.dialog);e&&!e.open&&e.showModal(),Oe(e)}function He(){const e=c(y.dialog);if(e)try{e.open&&e.close()}catch(t){console.warn(t)}}async function Bi(e){const t=Di(),n=["create","sequential"].includes(Ut),a=n?Pi(t):null;if(a){u==null||u(a);return}const i=Ui(e,t,n),s=Ti(t.stateChoice),o=n?Oi():1;try{let r="Saved";await E(async()=>{if(n&&o>1)r=await Hi(t,o,s);else if(n)await ji(i,t,s);else{const l=qi(e,i);await Ri(l,t,s)}},Ai),He(),u==null||u(r),ae==null||ae()}catch(r){u==null||u((r==null?void 0:r.message)||"Save failed")}}function Pi(e){const t=le(e.dccDigits,P);return t||(e.selectedPrefix?null:"Select a connection/prefix")}function Ui(e,t,n){var a;return n?`${t.selectedPrefix||""}${t.dccDigits||""}`.trim():((e==null?void 0:e.name)||(e==null?void 0:e.address)||((a=e==null?void 0:e.data)==null?void 0:a.name)||"").trim()}function qi(e,t){var n;return(e==null?void 0:e.name)||(e==null?void 0:e.address)||((n=e==null?void 0:e.data)==null?void 0:n.name)||t}async function ji(e,t,n){const a=(t.userName||"").trim()||String(t.dccDigits||"");await Bt({systemName:e,userName:a,comment:t.comment}),n!==null&&await ue(e,{state:n})}async function Ri(e,t,n){const a={userName:t.userName,comment:t.comment};n!==null&&(a.state=n),await ue(e,a)}async function Hi(e,t,n){const a=Number(e.dccDigits);if(!Number.isFinite(a))throw new Error("Invalid base DCC address");const i=e.selectedPrefix||"";if(!i)throw new Error("Select a connection/prefix");let s=0;const o=[];for(let l=0;l<t;l++){const d=a+l,f=`${i}${d}`,h=await K(),v=Ae(h),b=ke(e.userName,d,v,l===0);try{await Bt({systemName:f,userName:b,comment:e.comment}),n!==null&&await ue(f,{state:n}),s+=1}catch(p){o.push({dcc:d,message:(p==null?void 0:p.message)||"create failed"})}}if(o.length===0)return`Created ${s} lights`;if(s===0)return`No lights created (${o.length} failed)`;const r=o.slice(0,3).map(l=>l.dcc).join(", ");return`Created ${s}/${t}; failed: ${o.length} (${r}${o.length>3?"…":""})`}async function _e(e,t,n){var s,o,r,l,d,f,h,v,b;Ut=e,ae=n||null,Mi(["create","sequential"].includes(e)?"Add Light":"Edit Light"),Fi(e==="sequential");const a=c(y.count);a&&(a.value="1");try{await ki();const p=c(y.prefix);if(e==="edit"){const M=(t==null?void 0:t.name)||(t==null?void 0:t.address)||((s=t==null?void 0:t.data)==null?void 0:s.name)||"",k=Ii(M);p&&k&&(p.value=k),c(y.delete).hidden=!1,Ee(t,k)}else p&&p.options.length>0&&!p.value&&(p.value=p.options[0].value),c(y.delete).hidden=!0,Ee(null,null)}catch{Ee(e==="edit"?t:null,null)}const i=c(y.system);i&&i.toggleAttribute("readonly",e==="edit"),be&&be(),be=Te({input:i,saveButton:c(y.save),rules:P,errorId:"lightSystemNameError",disableSaveWhenInvalid:!0}),xi(),(o=c(y.save))==null||o.removeEventListener("click",we),(r=c(y.delete))==null||r.removeEventListener("click",Se),(l=c(y.cancel))==null||l.removeEventListener("click",j),(d=c(y.close))==null||d.removeEventListener("click",j),we=()=>Bi(t),Se=()=>Ht(t),j=()=>He(),(f=c(y.delete))==null||f.addEventListener("click",Se),(h=c(y.save))==null||h.addEventListener("click",we),(v=c(y.cancel))==null||v.addEventListener("click",j),(b=c(y.close))==null||b.addEventListener("click",j)}const _i="lights",jt="Loading lights…",zi="Deleting…",Ce={initialized:!1,items:[]};function ct(e){try{u==null||u(e)}catch(t){console.warn(t)}}async function K(){const e=await rn(),t=Ei(e);return Ce.items=t,t}function W(e){const t=c(ne.list);if(t&&(t.innerHTML="",(e||[]).forEach(n=>{const a=Ci(n,{onToggle:()=>Zi(n),onEdit:()=>Gi(n),onDelete:()=>Ht(n)});t.appendChild(a)}),!e||e.length===0)){const n=document.createElement("div");n.className="empty",n.innerHTML=`
      <div class="empty-title">No lights yet</div>
      <div class="empty-subtitle">Add a light to get started.</div>
    `,t.appendChild(n)}}async function Rt(){if(!Ce.initialized){Ce.initialized=!0,W([]);try{await E(async()=>{const e=await K();W(e)},jt)}catch{}}}function Wi(e){var t;((t=e==null?void 0:e.detail)==null?void 0:t.name)===_i&&Rt()}async function ze(){return E(async()=>{const e=await K();W(e)},jt)}function ut(){_e("create",null,()=>{ze()})}function Vi(){_e("sequential",null,()=>{ze()})}function Gi(e){_e("edit",e,()=>{ze()})}async function Ht(e){var a;const t=e.name||e.address||((a=e.data)==null?void 0:a.name);if(!(!t||!confirm(`Delete light "${e.title||t}"?
This cannot be undone.`)))try{await E(async()=>{await Li(t);const i=await K();W(i)},zi),ct("Light deleted")}catch{ct("Delete failed")}finally{He()}}function Xi(){document.addEventListener("panel:changed",Wi),Ji();const{panelElement:e}=Pt();e&&!e.hasAttribute("hidden")&&Rt()}function Ji(){const{addButtonElement:e}=Pt(),t=document.getElementById("addLightMore"),n=document.getElementById("addLightMenu");if(!t||!n||!e)return;e.addEventListener("click",()=>{ut()});const a=()=>{n.hidden=!1,t.setAttribute("aria-expanded","true"),document.addEventListener("click",s,{capture:!0})},i=()=>{n.hidden=!0,t.setAttribute("aria-expanded","false"),document.removeEventListener("click",s,{capture:!0})},s=o=>{n.contains(o.target)||t.contains(o.target)||i()};t.addEventListener("click",o=>{o.stopPropagation(),n.hidden?a():i()}),n.addEventListener("click",o=>{const r=o.target.closest(".menu-item");if(!r)return;const l=r.dataset.action;i(),l==="single"&&ut(),l==="sequential"&&Vi()})}function Ki(e){return e?4:2}async function Zi(e){var o;const t=e.name||e.address||((o=e.data)==null?void 0:o.name);if(!t)return;const n=!!e.isOff,i=!!e.isOn?!0:!n,s=Ki(i,!!e.inverted);try{await ue(t,{state:s});const r=await K();W(r);try{u==null||u(`Light ${i?"Off":"On"}`)}catch(l){console.warn(l)}}catch{try{u==null||u("Toggle failed")}catch(r){console.warn(r)}}}(function(){Ln(),zt(),dn(),_t(),Ua(),Ra(),vi(),Xi()})();
//# sourceMappingURL=index-DVRZBrqs.js.map
