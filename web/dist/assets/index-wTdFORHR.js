(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const J={roster:"panelRoster",turnouts:"panelTurnouts",settings:"panelSettings"},Fe={roster:"navRoster",turnouts:"navTurnouts",settings:"navSettings"};function $e(e){return document.getElementById(e)}function ae(e){const t=String(e||"roster");for(const n of Object.keys(J)){const a=$e(J[n]);a&&(n===t?a.removeAttribute("hidden"):a.setAttribute("hidden",""))}for(const n of Object.keys(Fe)){const a=$e(Fe[n]);a&&(a.classList.toggle("active",n===t),a.setAttribute("aria-current",n===t?"page":"false"))}document.dispatchEvent(new CustomEvent("panel:changed",{detail:{name:t}}))}function gt(){document.addEventListener("click",t=>{const n=t.target.closest(".nav-btn[data-view]");if(!n)return;const a=n.getAttribute("data-view");a&&ae(a)}),window.addEventListener("hashchange",()=>{const t=window.location.hash.replace(/^#/,"");Object.prototype.hasOwnProperty.call(J,t)&&ae(t)});const e=window.location.hash.replace(/^#/,"")||"roster";ae(Object.prototype.hasOwnProperty.call(J,e)?e:"roster")}function yt(){const e=document.getElementById("drawer");if(!e)return;const t=Array.from(document.querySelectorAll("#menuBtn, .menu-btn")),n=a=>{a.stopPropagation(),e.classList.toggle("open")};t.forEach(a=>a.addEventListener("click",n)),e.addEventListener("click",a=>{a.target.closest(".drawer .nav-btn")&&e.classList.remove("open")}),document.addEventListener("keydown",a=>{a.key==="Escape"&&e.classList.remove("open")}),document.addEventListener("click",a=>{e.classList.contains("open")&&(a.target.closest(".drawer, #menuBtn, .menu-btn")||e.classList.remove("open"))})}const ht=window.location.origin;function Q(e){return new URL(e,ht).toString()}async function R(e){const t=e.headers.get("content-type")||"",n=/application\/json/i.test(t),a=await e.text();return n&&(a.length===0||a===null)?!0:n?JSON.parse(a):a}function q(e){if(!e.ok)throw new Error(`${e.status} ${e.statusText}`)}async function L(e){const t=await fetch(Q(e),{credentials:"same-origin",headers:{Accept:"application/json"}});return q(t),R(t)}async function _e(e){const t=await fetch(Q(e),{credentials:"same-origin",method:"POST",headers:{Accept:"application/json"}});return q(t),R(t)}async function j(e,t,n="POST"){const a=await fetch(Q(e),{method:n,credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:t});return q(a),R(a)}async function He(e,t){const n=await fetch(Q(e),{method:"POST",credentials:"same-origin",body:t});return q(n),R(n)}async function K(e,t,n){const a=await fetch(t,{method:e,headers:{"Content-Type":"application/json"},body:n?JSON.stringify({data:n}):void 0});return q(a),R(a)}const H={shortAddress:1,longAddrMsb:17,longAddrLsb:18,config:29},Oe={longAddressMode:32},vt=192;async function bt(e){const n=(await fe()||[]).find(a=>((a==null?void 0:a.id)||"")===e);return(n==null?void 0:n.fileName)||null}async function wt(){var e;try{const t=await L("/json/railroad"),n=Array.isArray(t)?t.find(a=>a&&a.type==="railroad"):null;return((e=n==null?void 0:n.data)==null?void 0:e.name)||"My Railroad"}catch{return"My Railroad"}}async function fe(e={}){const n=!!e.fresh?`/api/roster?t=${Date.now()}`:"/api/roster";return L(n)}async function St(e){const t=`/api/roster/decoder?id=${encodeURIComponent(e)}`;return L(t)}async function Et(e){const t=new URLSearchParams;return t.set("file",e),j("/api/roster/delete",t)}async function Nt(e,t){const n=new URLSearchParams;return n.set("file",e),n.set("id",t.id||""),n.set("address",t.address||""),n.set("road",t.road||""),n.set("number",t.number||""),n.set("owner",t.owner||""),n.set("model",t.model||""),Object.prototype.hasOwnProperty.call(t,"image")&&n.set("image",t.image||""),j("/api/roster/add",n)}async function Ct(e,{family:t,model:n,manufacturer:a,mfgId:i,mfgName:o,productId:r,modelId:s}){if(!e)throw new Error("Missing rosterId");if(!t||!n)throw new Error("Missing family/model");const c=new URLSearchParams({id:e,family:t,model:n});return a&&c.append("manufacturer",a),i!==null&&typeof i<"u"&&c.append("mfgId",String(i)),r!==null&&typeof r<"u"&&c.append("productId",String(r)),o!==null&&typeof o<"u"&&c.append("mfgName",String(o)),s!==null&&typeof s<"u"&&c.append("modelId",String(s)),j("/api/roster/decoder/save",c)}async function Lt(e,t){const n=new FormData;return n.append("image",t,t.name),He(`/api/roster/image?id=${encodeURIComponent(e)}`,n)}async function At(e,t){const n=new FormData;return n.append("file",e,t),He("/api/roster/add",n)}async function pe(e){return L(`/api/roster/fn/list?file=${encodeURIComponent(e)}`)}async function It(e,t){const n=new URLSearchParams;n.set("file",e);for(const a of t)n.append("num[]",String(a.num??"")),n.append("label[]",String(a.label??"")),n.append("lockable[]",a.lockable?"true":"false"),n.append("img[]",String(a.img??"")),n.append("imgSel[]",String(a.imgSel??""));return j("/api/roster/fn/save",n)}async function kt(){const e=await L("/api/jmri/read?list=1,17,18,29"),t=(e==null?void 0:e.values)??e??{},n=Number(t[String(H.config)]);if(!Number.isFinite(n))return"";if((n&Oe.longAddressMode)===Oe.longAddressMode){const o=Number(t[String(H.longAddrMsb)]),r=Number(t[String(H.longAddrLsb)]);if(!Number.isFinite(o)||!Number.isFinite(r))return"";const s=256*(o-vt)+r;return String(s)}const i=Number(t[String(H.shortAddress)]);return Number.isFinite(i)?String(i):""}async function Tt(e,t={}){const n=t.mode==="ops"?"ops":"service",a=Number(e);if(!Number.isFinite(a)||a<=0||a>9999)throw new Error("Invalid DCC address");const i=new URLSearchParams;if(i.set("mode",n),i.set("newAddress",String(a)),n==="ops"){const r=Number(t.currentAddress),s=typeof t.currentLong=="boolean"?t.currentLong:r>=128;if(!Number.isFinite(r)||r<=0)throw new Error("Ops mode requires { currentAddress, currentLong } to reach the decoder");i.set("address",String(r)),i.set("long",String(!!s))}const o=await j("/api/jmri/writeAddress",i);if(!o||o.ok!==!0)throw new Error(o&&o.message||"Address write failed");return o}async function Dt({dccAddress:e}={}){const t=await fetch("/api/decoder/identify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dccAddress:e})});if(!t.ok){let n="";try{n=await t.text()}catch(a){console.warn(a)}throw new Error(n||"Failed to read decoder")}return t.json()}async function Ft(){let e=null,t=null;try{if(e=await L("/json/turnouts"),e)return e}catch(n){t=n}throw t||new Error("No turnout data")}let G=null;function $t(e){G=e}async function Ot(){return L("/api/store/user/file")}async function We(e){const t=e?`/api/store/user?file=${encodeURIComponent(e)}`:"/api/store/user";return _e(t)}async function Ve(){return L("/api/connections")}async function Mt(e){return _e(`/api/connections/select?systemPrefix=${e}`)}const Me="AutoStorePanels.xml";let xe=0,V=null;async function xt(){await Pt(),await Bt()}async function Pt(e=800){if(!G){let t="";try{const n=await Ot();t=(n==null?void 0:n.fileName)||Me}catch{t=Me}$t(t)}clearTimeout(xe),xe=setTimeout(()=>{We(G).catch(()=>{})},e)}async function Bt(){const e=await Ve();ze(e)}function ze(e){V=e.find(t=>t.active)??null}(function(){const t="__APP_BUSY_OVERLAY__";if(window[t])return;const n={count:0,dialogEl:null,fallbackEl:null,labelEl:null,watchdogTimer:null,supportsDialog(){return typeof HTMLDialogElement<"u"},ensureOverlay(){if(!(this.dialogEl||this.fallbackEl))if(this.supportsDialog()){const a=document.createElement("dialog");a.id="appBusy",a.setAttribute("aria-live","polite"),a.setAttribute("aria-busy","true"),a.addEventListener("cancel",o=>o.preventDefault());const i=document.createElement("div");i.className="panel",i.innerHTML=`
          <div class="spinner" aria-hidden="true"></div>
          <div class="label" id="appBusyLabel">Working…</div>
        `,a.appendChild(i),document.body.appendChild(a),this.dialogEl=a,this.labelEl=i.querySelector("#appBusyLabel")}else{const a=document.createElement("div");a.id="appBusy",a.innerHTML=`
          <div class="panel" role="alert" aria-live="assertive">
            <div class="spinner" aria-hidden="true"></div>
            <div class="label" id="appBusyLabel">Working…</div>
          </div>
        `,document.body.appendChild(a),this.fallbackEl=a,this.labelEl=a.querySelector("#appBusyLabel")}},openOverlay(a){this.ensureOverlay();const i=document.getElementById("appBusy");i&&(i.style.display="grid"),this.labelEl&&(this.labelEl.textContent=a||"Working…"),this.dialogEl?(this.dialogEl.open||this.dialogEl.showModal(),document.body.setAttribute("aria-busy","true")):this.fallbackEl&&(this.fallbackEl.classList.add("active"),document.documentElement.style.pointerEvents="none",this.fallbackEl.style.pointerEvents="auto")},closeOverlay(){const a=document.getElementById("appBusy");if(a&&(a.style.display="none"),this.dialogEl){try{this.dialogEl.open&&this.dialogEl.close()}catch(i){console.warn(i)}document.body.removeAttribute("aria-busy")}this.fallbackEl&&(this.fallbackEl.classList.remove("active"),document.documentElement.style.pointerEvents="")},scheduleCloseWatchdog(){this.watchdogTimer||(this.watchdogTimer=setTimeout(()=>{this.watchdogTimer=null,this.count===0&&(this.closeOverlay(),queueMicrotask(()=>this.closeOverlay()),requestAnimationFrame(()=>this.closeOverlay()))},0))}};window[t]=n})();const N=window.__APP_BUSY_OVERLAY__;function Ut(e="Working…"){N.count+=1,N.count===1?N.openOverlay(e):N.labelEl&&(N.labelEl.textContent=e)}function Rt(){N.count>0&&(N.count-=1),N.count<0&&(N.count=0);const e=document.getElementById("appBusy");e&&(e.style.display="none"),N.count===0&&N.scheduleCloseWatchdog()}async function S(e,t="Working…"){Ut(t);try{return await e()}finally{Rt()}}const qt="toast",jt="toastLayer";let Pe=0;function _t(){const e=document.getElementById(jt),t=document.getElementById(qt);return!e||!t?{toastDialog:null,toastElement:null}:{toastDialog:e,toastElement:t}}function u(e,t=2e3){const{toastDialog:n,toastElement:a}=_t();!n||!a||(a.textContent=String(e??""),n.open||n.show(),a.classList.add("show"),clearTimeout(Pe),Pe=setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{n.open&&n.close()},200)},Number.isFinite(t)?t:2e3))}const ee=Object.freeze({required:!0,digitsOnly:!0,maxDigits:4,min:1,max:9999});function ge(e,t={}){const{required:n=!0,digitsOnly:a=!0,maxDigits:i=4,min:o=1,max:r=9999}=t,s=String(e??"").trim();if(n&&!s)return"DCC Address is required";if(!n&&!e)return null;if(a&&!/^\d+$/.test(s))return"Use digits only (0-9)";if(i&&s.length>i)return`Max ${i} digits`;const c=Number(s);return Number.isNaN(c)?"DCC Address must be numeric":c<o||c>r?`DCC Address must be between ${o} and ${r}`:null}function Ht(e,t,n="fn-error"){let a=document.getElementById(t);return a||(a=document.createElement("div"),a.id=t,a.className=n,a.setAttribute("role","alert"),a.setAttribute("aria-live","polite"),e.insertAdjacentElement("afterend",a)),a}function Wt(e,t=4){e&&(e.setAttribute("inputmode","numeric"),e.setAttribute("pattern","\\d*"),e.setAttribute("autocomplete","off"),e.setAttribute("maxlength",String(t)))}function Vt({input:e,errorEl:t,saveButton:n,writeDccButton:a,rules:i={},disableSaveWhenInvalid:o=!0}){if(!e)return!0;const r=ge(e.value,i);return t&&(t.textContent=r||""),e.setAttribute("aria-invalid",r?"true":"false"),n&&o&&(n.disabled=!!r,a&&(a.disabled=!!r)),!r}function Xe({input:e,saveButton:t,writeDccButton:n,rules:a={},errorId:i="dccAddressError",disableSaveWhenInvalid:o=!0}){if(!e)return()=>{};Wt(e,a.maxDigits??4);const r=Ht(e,i),s=()=>Vt({input:e,errorEl:r,saveButton:t,writeDccButton:n,rules:a,disableSaveWhenInvalid:o});return s(),e.addEventListener("input",s),()=>e.removeEventListener("input",s)}function Je(e){return String(e).trim().replace(/[^\w.-]+/g,"_").replace(/^_+|_+$/g,"")||"unnamed"}async function zt(e="#railroadName"){const t=document.querySelector(e);if(t)try{const n=await wt();t.textContent=n||"My Railroad"}catch{t.textContent="My Railroad"}}function C(e){return(e??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}async function Xt(){await zt()}function l(e,t=document){return t.querySelector(e)}function g(e,t=""){const n=l(e);n&&(n.value=t)}function F(e){var n;const t=l(e);return((n=t==null?void 0:t.value)==null?void 0:n.trim())??""}function Jt(e){const t=l(e);return!!(t!=null&&t.checked)}function Ke(e,t=""){const n=l(e);n&&(n.src=t||"")}function Kt(e){const t=(e||"").trim();return t?`/api/roster/icon?id=${encodeURIComponent(t)}&v=${Date.now()}`:""}function Gt(e=document){e.querySelectorAll('[role="tablist"]').forEach(n=>Yt(n))}function Yt(e){const t=Array.from(e.querySelectorAll('[role="tab"]'));if(t.length===0)return;t.some(a=>a.getAttribute("aria-selected")==="true")||t[0].setAttribute("aria-selected","true"),Ge(t),t.forEach(a=>{a.addEventListener("click",()=>{Zt(a,t)})})}function Zt(e,t,n={}){const{focus:a=!1}=n;t.forEach(i=>{i.setAttribute("aria-selected",i===e?"true":"false")}),Ge(t),a&&e.focus()}function Ge(e){e.map(a=>a.getAttribute("aria-controls")).filter(Boolean).forEach(a=>{const i=document.getElementById(a);i&&(i.hidden=!0)});const n=e.find(a=>a.getAttribute("aria-selected")==="true");if(n){const a=n.getAttribute("aria-controls"),i=a?document.getElementById(a):null;i&&(i.hidden=!1)}}function Ye(e,t=null){if(!e)return;const n=Array.from(e.querySelectorAll('[role="tab"]'));let a=null;t&&(a=n.find(o=>o.getAttribute("aria-controls")===t||o.dataset.panel===t||o.dataset.target===t)||null),a||(a=n[0]||null),a&&Qt(e,a);const i=e.querySelector(".modal-body")||e;i.scrollTop=0}function Qt(e,t){const n=e.querySelectorAll('[role="tab"]'),a=e.querySelectorAll('[role="tabpanel"]');n.forEach(o=>o.setAttribute("aria-selected","false")),t.setAttribute("aria-selected","true");const i=t.getAttribute("aria-controls")||t.dataset.panel||t.dataset.target||"";a.forEach(o=>{o.hidden=o.id!==i})}async function en(e){try{await S(async()=>{var a,i;const t=await Dt(),n={family:(((a=e==null?void 0:e.dataset)==null?void 0:a.preferredFamily)||"").trim(),model:(((i=e==null?void 0:e.dataset)==null?void 0:i.preferredModel)||"").trim()};on(e,t,n)},"Reading DCC Decoder...")}catch(t){u==null||u((t==null?void 0:t.message)||"Failed to read DCC decoder")}}async function tn(e,t){var c;if(!e||!t)return!1;Ze(e,"Read from Loco to find decoder...");let n;try{n=await St(t)}catch{return!1}const a=n==null?void 0:n.decoder;if(!a)return!1;a.modelId=(c=n==null?void 0:n.identify)==null?void 0:c.modelId;const i=(a.manufacturer||"").trim(),o=(a.family||"").trim(),r=(a.model||"").trim();if(!i&&!o&&!r)return!1;sn(e,1);const s=Qe({manufacturer:i,family:o,model:r,isVariant:!1,mfgId:a.manufacturerId,mfgName:a.manufacturer,productId:a.productId,modelId:a.modelId,value:"saved"});return e.appendChild(s),s.selected=!0,e.disabled=!1,e.dataset.preferredFamily=o,e.dataset.preferredModel=r,!0}function k(e){return String(e??"").replace(/\s+/g," ").trim()}function Be(e,t,n){return[k(e).toLowerCase(),k(t).toLowerCase(),k(n).toLowerCase()].join("|")}function nn(e){const t=[],n=new Set,a=Array.isArray(e==null?void 0:e.candidates)?e.candidates:[],i=(e==null?void 0:e.identify)??{};for(let o=0;o<a.length;o++){const r=a[o]||{},s=k(r.manufacturer),c=k(r.family),m=k(r.model),p=Be(s,c,m);n.has(p)||(n.add(p),t.push({label:[s,c,m].filter(Boolean).join(" — "),manufacturer:s,family:c,model:m,mfgId:i.mfgId,mfgName:i.mfgName,productId:i.productId,modelId:i.modelId,isVariant:!1}));const v=Array.isArray(r.variants)?r.variants:[];for(let h=0;h<v.length;h++){const E=k(v[h]);if(!E)continue;const b=Be(s,c,E);n.has(b)||(n.add(b),t.push({label:[s,c,E].filter(Boolean).join(" — "),manufacturer:s,family:c,model:E,mfgId:i.mfgId,mfgName:i.mfgName,productId:i.productId,modelId:i.modelId,isVariant:!0}))}}return t}function an(e){const t=document.createDocumentFragment(),n=document.createElement("option");return n.value="",n.disabled=!0,n.selected=!0,n.textContent=`${e.length} Options Found...`,t.appendChild(n),e.forEach((a,i)=>{const o=Qe({...a,value:String(i)});t.appendChild(o)}),t}function on(e,t,n){const a=nn(t),i=an(a);return e.innerHTML="",e.appendChild(i),e.disabled=!1,n&&(n.family||n.model)&&cn(e,n.family,n.model),a}function rn(e){var r,s,c,m,p;const t=(r=e.selectedOptions)==null?void 0:r[0];if(!t||!t.value)return null;const n=((s=t==null?void 0:t.dataset)==null?void 0:s.mfgId)??void 0,a=((c=t==null?void 0:t.dataset)==null?void 0:c.productId)??void 0,i=((m=t==null?void 0:t.dataset)==null?void 0:m.mfgName)??void 0,o=((p=t==null?void 0:t.dataset)==null?void 0:p.modelId)??void 0;return{family:t.dataset.family||"",model:t.dataset.model||"",manufacturer:t.dataset.manufacturer||"",isVariant:t.dataset.isVariant==="true",mfgId:n,productId:a,mfgName:i,modelId:o}}function Ze(e,t){e.innerHTML="";const n=document.createElement("option");n.value="",n.dataset.placeholder="true",n.disabled=!0,n.selected=!0,n.textContent=t,e.appendChild(n),e.disabled=!1}function sn(e,t){const n=e.querySelector('option[data-placeholder="true"]');n&&(n.textContent=`${t} Options Found...`)}function Qe({manufacturer:e="",family:t="",model:n="",isVariant:a=!1,mfgId:i,productId:o,mfgName:r,modelId:s,value:c="opt"}){const m=document.createElement("option");return m.value=c,m.textContent=[e,t,n].filter(Boolean).join(" — ")||"Saved Decoder",m.dataset.manufacturer=e,m.dataset.family=t,m.dataset.model=n,m.dataset.isVariant=String(!!a),i!=null&&(m.dataset.mfgId=String(i)),o!=null&&(m.dataset.productId=String(o)),r!=null&&(m.dataset.mfgName=String(r)),s!=null&&(m.dataset.modelId=String(s)),m}function cn(e,t,n){const a=(t||"").toLowerCase().trim(),i=(n||"").toLowerCase().trim();for(const o of e.options){if(!o.value)continue;const r=(o.dataset.family||"").toLowerCase(),s=(o.dataset.model||"").toLowerCase();if((!a||r===a)&&(!i||s===i))return o.selected=!0,!0}return!1}function ln(e,t=!1){var p;const n=(e==null?void 0:e.id)||(e==null?void 0:e.title)||"",a=(e==null?void 0:e.address)||"",i=(e==null?void 0:e.road)||"",o=(e==null?void 0:e.number)||"",r=(e==null?void 0:e.model)||"",s=(e==null?void 0:e.owner)||"",c=(e==null?void 0:e.file)||((p=e==null?void 0:e.data)==null?void 0:p.fileName)||"",m=e!=null&&e.imageUrl?`${e.imageUrl}&v=${Date.now()}`:Kt(n);tn(l(d.decoderSelect),n),t?Y=(e==null?void 0:e.imageUrl)||"":Y=n?`/api/roster/icon?id=${encodeURIComponent(n)}`:(e==null?void 0:e.imageUrl)||"",g(d.id,n),g(d.dcc,a),g(d.road,i),g(d.number,o),g(d.model,r),g(d.owner,s),g(d.file,c),g(d.imageUrl,m),Ke(d.imageEl,m)}function un(){g(d.id,""),g(d.dcc,""),g(d.road,""),g(d.number,""),g(d.model,""),g(d.owner,""),g(d.file,""),g(d.imageUrl,""),Ke(d.imageEl,""),Ze(l(d.decoderSelect),"Read from Loco to find decoder...")}function et(){var c,m,p,v,h,E,b,_,D,Ce,Le,Ae,Ie,ke,Te,De;const e=((m=(c=l(d.id))==null?void 0:c.value)==null?void 0:m.trim())||"",t=((v=(p=l(d.dcc))==null?void 0:p.value)==null?void 0:v.trim())||"",n=((E=(h=l(d.road))==null?void 0:h.value)==null?void 0:E.trim())||"",a=((_=(b=l(d.number))==null?void 0:b.value)==null?void 0:_.trim())||"",i=((Ce=(D=l(d.model))==null?void 0:D.value)==null?void 0:Ce.trim())||"",o=((Ae=(Le=l(d.owner))==null?void 0:Le.value)==null?void 0:Ae.trim())||"",r=((ke=(Ie=l(d.file))==null?void 0:Ie.value)==null?void 0:ke.trim())||"",s=((De=(Te=l(d.imageUrl))==null?void 0:Te.value)==null?void 0:De.trim())||"";return{id:e,address:t,road:n,number:a,model:i,owner:o,file:r,imageUrl:s}}let ye=null,Y="";function dn(){ye=null,Y=""}function mn(){const e=l(d.dropZone),t=l(d.fileInput),n=l(d.imageEl);if(!e||!t||!n)return;t.replaceWith(t.cloneNode(!0));const a=l(d.fileInput);e.addEventListener("click",()=>a==null?void 0:a.click()),["dragenter","dragover"].forEach(i=>e.addEventListener(i,o=>{o.preventDefault(),o.stopPropagation(),e.classList.add("drag")})),["dragleave","drop"].forEach(i=>e.addEventListener(i,o=>{o.preventDefault(),o.stopPropagation(),e.classList.remove("drag")})),e.addEventListener("drop",i=>{var r,s;const o=(s=(r=i.dataTransfer)==null?void 0:r.files)==null?void 0:s[0];o&&Ue(o,n)}),a.addEventListener("change",()=>{var o;const i=(o=a.files)==null?void 0:o[0];i&&Ue(i,n)})}function Ue(e,t){ye=e;const n=URL.createObjectURL(e);t.src=n}function fn(){return ye}function pn(){return Y||""}function gn(e){try{return new URL(e,window.location.origin).toString()}catch{return""}}async function yn(e,t){if(!e)return null;const n=gn(e);if(!n)return null;try{const a=await fetch(n,{credentials:"same-origin"});if(!a.ok)return null;const i=await a.blob(),o=i.type||"image/jpeg",r=o==="image/png"?"png":o==="image/webp"?"webp":o==="image/gif"?"gif":o==="image/svg+xml"?"svg":"jpg",s=(t||"image").replace(/[^\w.-]+/g,"_");return new File([i],`${s}.${r}`,{type:o})}catch{return null}}async function hn({pickedFile:e,existingSrc:t,rosterId:n}){if(e)return{fileToUpload:e,imageField:void 0};const a=t==null?void 0:t.startsWith("blob:");if(t&&!a){const i=await yn(t,n);return i?{fileToUpload:i,imageField:void 0}:{fileToUpload:null,imageField:t}}return{fileToUpload:null,imageField:""}}function vn(){return et()}async function bn(){try{await S(async()=>{const e=await kt();if(e!==null&&String(e).trim()!==""){g(d.dcc,String(e).trim());const t=l(d.dcc);t==null||t.dispatchEvent(new Event("input",{bubbles:!0})),u("DCC address read")}else u("No address detected")},"Reading DCC Address...")}catch(e){u((e==null?void 0:e.message)||"Failed to read DCC address")}}async function wn(){try{await S(async()=>{const e=et().address;await Tt(e,{mode:"service"}),u("DCC address written")},"Writing DCC Address...")}catch(e){u((e==null?void 0:e.message)||"Failed to write DCC address")}}const $={list:"#fnList",addButton:"#fnAdd",copySelect:"#fnCopySelect"},M=28;let P="",Re=!1,y=[];function O(e,t=document){return t.querySelector(e)}function Sn(e,t,n){return Math.min(n,Math.max(e,t))}function tt(){y.sort((e,t)=>Number(e.num)-Number(t.num))}function En(){const e=new Set(y.map(t=>Number(t.num)));for(let t=0;t<=M;t+=1)if(!e.has(t))return t;return null}function Nn(e){const t=new Set(y.map(n=>Number(n.num)));if(!t.has(e))return e;for(let n=e+1;n<=M;n+=1)if(!t.has(n))return n;for(let n=0;n<e;n+=1)if(!t.has(n))return n;return null}function Cn(e){return`
    <li class="fn-card" data-fn-num="${e.num}">
      <div class="fn-row">
        <div class="fn-num">
          <input
            type="number"
            class="fn-num-input"
            inputmode="numeric" pattern="\\d*"
            min="0" max="${M}"
            value="${e.num}"
            aria-label="Function number"
          >
        </div>

        <div class="fn-label">
          <input
            type="text"
            class="fn-label-input"
            value="${C(e.label||"")}"
            placeholder="Label (e.g. Horn)"
            aria-label="Function label"
          >
        </div>

        <div class="fn-lock">
          <label class="row row--stack" style="gap:6px">
            <span>Lockable</span>
            <input type="checkbox" class="fn-lock-input" ${e.lockable?"checked":""}>
          </label>
        </div>

        <div class="fn-actions">
          <button
            type="button"
            class="icon-btn fn-delete-btn"
            aria-label="Delete function"
            title="Delete"
            style="padding:4px;border:0;background:transparent;color:#a62622"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
    </li>
  `}function T(){const e=O($.list);e&&(tt(),e.innerHTML=y.map(Cn).join(""))}async function Ln(){const e=O($.copySelect);if(!e)return;e.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="Copy functions from…",e.appendChild(t);let n=[];try{const r=await fe({fresh:!1});n=Array.isArray(r)?r:[]}catch{return}const i=n.map(r=>{var m,p;const s=r.fileName||r.file||((m=r.data)==null?void 0:m.fileName)||"",c=r.id||r.title||r.name||((p=r.data)==null?void 0:p.name)||"";return{fileName:s,displayId:c}}).filter(r=>r.fileName&&r.displayId).filter(r=>r.fileName!==P),o=await An(i,4);o.sort((r,s)=>String(r.displayId).localeCompare(String(s.displayId),void 0,{numeric:!0,sensitivity:"base"}));for(const r of o){const s=document.createElement("option");s.value=r.fileName;const c=` (${r.functionCount})`;s.textContent=`${r.displayId}${c}`,e.appendChild(s)}}async function An(e,t=4){const n=[];let a=0;async function i(){for(;a<e.length;){const r=a++,s=e[r];try{const c=await pe(s.fileName);Array.isArray(c)&&c.length>0&&n.push({fileName:s.fileName,displayId:s.displayId,functionCount:c.length})}catch{}}}const o=Math.max(1,Math.min(t,e.length));return await Promise.all(Array.from({length:o},()=>i())),n}async function In(){const e=O($.copySelect);if(!e)return;const t=e.value;if(t&&!(y.length>0&&!window.confirm("Replace current functions with those from the selected loco?")))try{const n=await pe(t);y=(Array.isArray(n)?n:[]).map(i=>({num:Number(i.num),label:i.label??"",lockable:!!i.lockable})).filter(i=>Number.isFinite(i.num)&&i.num>=0&&i.num<=M),T(),u==null||u("Functions copied")}catch(n){u==null||u((n==null?void 0:n.message)||"Failed to copy functions")}}function kn(){const e=En();if(e===null){u==null||u("All function numbers (0-28) are already used");return}y.push({num:e,label:"",lockable:!1}),T()}function Tn(e){const t=Number(e.dataset.fnNum);y=y.filter(n=>Number(n.num)!==t),T()}function Dn(e,t){const n=Number(e.dataset.fnNum),a=y.findIndex(m=>Number(m.num)===n);if(a<0)return;const i=y[a],o=Number(t.value);if(!Number.isFinite(o)){t.value=String(i.num);return}const r=Sn(0,o,M),s=i.num;i.num="__TEMP__";const c=Nn(r);if(i.num=s,c===null){t.value=String(s),u==null||u("No free function numbers available (0-28)");return}i.num=c,e.dataset.fnNum=String(c),t.value=String(c),T()}function Fn(e,t){const n=Number(e.dataset.fnNum),a=y.find(i=>Number(i.num)===n);a&&(a.label=t.value.trim())}function $n(e,t){const n=Number(e.dataset.fnNum),a=y.find(i=>Number(i.num)===n);a&&(a.lockable=!!t.checked)}function On(e){const t=e.target.closest(".fn-card");t&&e.target.closest(".fn-delete-btn")&&Tn(t)}function Mn(e){const t=e.target.closest(".fn-card");if(t){if(e.target.classList.contains("fn-num-input")){Dn(t,e.target);return}if(e.target.classList.contains("fn-label-input")){Fn(t,e.target);return}e.target.classList.contains("fn-lock-input")&&$n(t,e.target)}}function xn(){In()}function Pn(){if(Re)return;Re=!0;const e=O($.list),t=O($.addButton),n=O($.copySelect);t==null||t.addEventListener("click",kn),e==null||e.addEventListener("click",On),e==null||e.addEventListener("change",Mn),n==null||n.addEventListener("change",xn)}async function Bn(e){var t;if(Pn(),y=[],P=(e==null?void 0:e.file)||((t=e==null?void 0:e.data)==null?void 0:t.fileName)||"",await Ln(),!P){T();return}try{const n=await pe(P);y=(Array.isArray(n)?n:[]).map(a=>({num:Number(a.num),label:a.label??"",lockable:!!a.lockable})).filter(a=>Number.isFinite(a.num)&&a.num>=0&&a.num<=M),T()}catch(n){y=[],T(),u==null||u((n==null?void 0:n.message)||"Failed to load functions")}}async function Un(e){const t=(e==null?void 0:e.file)||P||"";if(!t)return;tt();const n=y.map(a=>({num:Number(a.num),label:a.label||"",lockable:!!a.lockable}));await It(t,n)}let ie=null;const d={dialog:"#locoDialog",title:"#locoDialogTitle",id:"#locoId",dcc:"#locoDccAddress",road:"#locoRoadName",number:"#locoNumber",model:"#locoModel",owner:"#locoOwner",file:"#locoFile",imageUrl:"#locoImageUrl",decoderSelect:"#locoDecoderSelect",imageEl:"#modalRosterImage",dropZone:"#modalImageDrop",fileInput:"#modalImageInput",save:"#locoSave",cancel:"#locoCancel",close:"#locoClose",delete:"#locoDelete",readDcc:"#locoReadAddress",writeDcc:"#locoWriteAddress",readDccChip:"#locoDecoderRead"};function Rn(e){const t=l(d.title);t&&(t.textContent=e==="create"?"Add Locomotive":"Edit Locomotive")}function qn(e){const t=l(d.id);t&&t.toggleAttribute("readonly",e==="edit")}function A(e){const t=l(e);if(!t)return null;const n=t.cloneNode(!0);return t.replaceWith(n),n}function jn(e){e&&!e.open&&e.showModal()}function he(){const e=l(d.dialog);try{e!=null&&e.open&&e.close()}catch(t){console.warn(t)}dn()}async function Z(e,t,n,a=!1){const i=l(d.dialog);if(!i)return;Rn(e),qn(e),t?ln(t,a):un(),Gt(i),mn();const o=A(d.save),r=A(d.cancel),s=A(d.close),c=A(d.delete),m=A(d.readDcc),p=A(d.writeDcc),v=A(d.readDccChip);o==null||o.addEventListener("click",()=>Hn(n));const h=()=>he();r==null||r.addEventListener("click",h),s==null||s.addEventListener("click",h),c==null||c.addEventListener("click",()=>Wn(n)),m==null||m.addEventListener("click",bn),p==null||p.addEventListener("click",wn),v==null||v.addEventListener("click",()=>en(l(d.decoderSelect))),e==="edit"?c.hidden=!1:c.hidden=!0;const E=l(d.dcc);ie&&ie(),ie=Xe({input:E,saveButton:l(d.save),writeDccButton:l(d.writeDcc),rules:ee,errorId:"rosterSystemNameError",disableSaveWhenInvalid:!0});try{await Bn(t)}catch(b){console.warn(b)}jn(i),Ye(i)}let W=null;async function ve(){const e=await fe({fresh:!0});return Array.isArray(e)?e.map(_n).filter(Boolean):[]}function _n(e){if(!e||typeof e!="object")return null;const t=I(e.id),n=I(e.fileName),a=I(e.address),i=I(e.road),o=I(e.number),r=I(e.model),s=I(e.owner),c=t?`/api/roster/icon?id=${encodeURIComponent(t)}`:"";return{title:t,address:a,road:i,number:o,model:r,owner:s,imageUrl:c,id:t,file:n,data:e}}function I(e){return e===null?"":String(e)}async function Hn(e){const t=vn();if(!t.id){u("ID is required");return}const n=ge(t.address,ee);if(n){u==null||u(n);return}try{await S(async()=>{let a=t.file;const{fileToUpload:i,imageField:o}=await hn({pickedFile:fn(),existingSrc:pn(),rosterId:t.id}),r=t.file||`${Je(t.id)}.xml`,s={...t,file:r,...typeof o<"u"?{image:o}:{}};await Nt(s.file,s),a=await bt(t.file),a&&g(d.file,a),i&&await Lt(s.id,i);const c=l(d.decoderSelect),m=rn(c);m&&await Ct(s.id,m),await Un(s)},"Saving…"),he(),u("Saved"),e==null||e()}catch(a){u((a==null?void 0:a.message)||"Save failed")}}async function Wn(e){const t=F(d.file);if(!t){u("Missing file to delete");return}try{await S(async()=>{await Et(t)},"Deleting…"),he(),u("Deleted"),e==null||e()}catch(n){u((n==null?void 0:n.message)||"Delete failed")}}function Vn(){if(W)return W;const e=document.createElement("input");return e.type="file",e.accept=".xml,application/xml,text/xml",e.hidden=!0,document.body.appendChild(e),e.addEventListener("change",async()=>{var s;const t=(s=e.files)==null?void 0:s[0];if(e.value="",!t)return;if(!(t.type==="application/xml"||t.type==="text/xml"||/\.xml$/i.test(t.name))){u("Please select an XML file");return}const i=(t.name||"unnamed.xml").replace(/\.[^.]+$/g,""),r=`${Je(i)}.xml`;try{await S(async()=>{await At(t,r),u("XML uploaded"),await ve(),B()},"Uploading XML…")}catch(c){u((c==null?void 0:c.message)||"Upload failed")}}),W=e,W}function zn(){Vn().click()}function Xn(e,t={}){var r;const n=document.createElement("article");n.className="card",n.dataset.rosterId=e.id;const a=e.title||"(unnamed)",i=Gn([e.address&&`DCC ${e.address}`,Kn(e.road,e.number),e.model,e.owner&&`Owner: ${e.owner}`]);n.innerHTML=`
    <div class="card-img" aria-hidden="true">
      ${Jn(e.imageUrl)}
    </div>
    <div class="card-body">
      <div class="card-title">${C(a)}</div>
      ${i.map(s=>`<div class="card-sub">${C(s)}</div>`).join("")}
    </div>
  `;const o=()=>{var s;return(s=t.onEdit)==null?void 0:s.call(t,e)};return n.addEventListener("click",o),(r=n.querySelector('[data-act="edit"]'))==null||r.addEventListener("click",s=>{s.stopPropagation(),o()}),n}function Jn(e){const t=(e||"").trim();return t?`<img class="card-img-media" src="${Yn(t)}&v=${Date.now()}" alt="" loading="lazy" decoding="async" data-roster-img="">`:'<span class="card-img-placeholder" aria-hidden="true"></span>'}function Kn(e,t){const n=(e||"").trim(),a=(t||"").trim();return!n&&!a?"":n&&a?`${n} ${a}`:n||a}function Gn(e){return(e||[]).filter(Boolean)}function Yn(e){return String(e).replace(/"/g,"&quot;")}const oe=Object.freeze({panel:"#panelRoster",list:"#rosterList",addButton:"#addBtn"});function be(e=document){return{panelElement:e.querySelector(oe.panel),listElement:e.querySelector(oe.list),addButton:e.querySelector(oe.addButton)}}function Zn(e,t){const n=String(e||"").trim();if(!n)return"";const a=c=>t.has(String(c).toLowerCase());if(!a(n))return n;const i=n.match(/^(.*?)(\d+)$/),o=i?i[1]:`${n}-`;let r=i?parseInt(i[2],10)+1:2,s=`${o}${r}`;for(;a(s);)r+=1,s=`${o}${r}`;return s}function Qn(e){const t=new Set;for(const n of e||[])n!=null&&n.id&&t.add(String(n.id).toLowerCase());return t}function ea(e){return`/api/roster/icon?id=${encodeURIComponent(e)}&v=${Date.now()}`}function ta(e,t){if(!e)return;const n=Qn(t),i={id:Zn(e.id,n),address:e.address||"",road:e.road||"",number:e.number||"",model:e.model||"",owner:e.owner||"",file:"",imageUrl:e.imageUrl||""};Z("create",i,()=>B(),!0)}const w={root:null,anchor:null,records:[],filtered:[]};function na(){if(w.root)return w.root;const e=document.createElement("div");e.className="copy-entryItem",e.hidden=!0;const t=document.createElement("div");t.className="copy-popover",t.role="tabpanel",t.hidden=!0,t.innerHTML=`
    <div class="copy-head">
      <input class="copy-search" type="search" placeholder="Search by ID, road, number, model, owner" aria-label="Search locos">
      <button class="copy-close" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="copy-list" role="listbox" aria-label="Locos"></div>
  `,document.body.appendChild(e),document.body.appendChild(t);const n=t.querySelector(".copy-search"),a=t.querySelector(".copy-list"),i=t.querySelector(".copy-close");w.root={entryItem:e,copyPopup:t,search:n,listContainer:a,closeButton:i};const o=()=>{e.hidden=!0,t.hidden=!0,t.removeAttribute("style"),w.anchor=null};return e.addEventListener("click",o),i==null||i.addEventListener("click",o),n.addEventListener("input",()=>{at(nt(w.records,n.value))}),w.root}function nt(e,t){const n=String(t||"").trim().toLowerCase();return n?(e||[]).filter(a=>[a.id,a.road,a.number,a.model,a.owner].some(i=>(i||"").toLowerCase().includes(n))).slice(0,200):(e||[]).slice(0,200)}function at(e){const{listContainer:t}=w.root;if(w.filtered=e,t.innerHTML="",!e.length){t.innerHTML='<div class="copy-item copy-item-no-results" aria-disabled="true">No matches</div>';return}e.forEach(n=>{const a=document.createElement("div");a.className="copy-item",a.setAttribute("role","option"),a.innerHTML=`
      <div class="copy-thumb"><img alt="" src="${ea(n.id)}"></div>
      <div class="copy-main">
        <div class="copy-title">${C(n.id)}</div>
        <div class="copy-sub">${C([n.road,n.number,n.model,n.owner].filter(Boolean).join(" | "))}</div>
      </div>
    `,a.addEventListener("click",i=>{(i.target.closest(".copy-choose")||i.currentTarget===a)&&aa(n)}),a.addEventListener("mouseenter",()=>{a.focus({preventScroll:!0})}),t.appendChild(a)})}function aa(e){const{entryItem:t,copyPopup:n}=w.root;t.hidden=!0,n.hidden=!0,n.removeAttribute("style"),w.anchor=null,ta(e,w.records)}function ia(e,t){const a=e.getBoundingClientRect().bottom+8;t.style.top=`${a}px`,t.style.right="10px"}async function oa(e){const t=na();w.anchor=e||document.getElementById("addLocoMore");try{const n=await ve();w.records=n||[]}catch(n){u((n==null?void 0:n.message)||"Failed to load roster");return}t.entryItem.hidden=!1,t.copyPopup.hidden=!1,at(nt(w.records,"")),ia(w.anchor,t.copyPopup),t.search.value="",t.search.focus({preventScroll:!0})}const ra="roster",sa="Loading roster…",de={initialized:!1,items:[]};function ca(){const{listElement:e}=be();return e||null}function it(e){const t=ca();t&&(t.innerHTML="",(e||[]).forEach(n=>{const a=Xn(n,{onEdit:()=>Z("edit",n,()=>B())});t.appendChild(a)}),(!e||e.length===0)&&(t.innerHTML=`
      <div class="empty">
        <div class="empty-title">No locomotives yet</div>
        <div class="empty-subtitle">Add a locomotive to get started.</div>
      </div>
    `))}async function ot(){const e=await ve();de.items=e,it(e)}async function rt(){if(!de.initialized){de.initialized=!0,it([]);try{await S(ot,sa)}catch{}}}async function B(){try{await S(ot,"Refreshing…")}catch{u("Refresh failed")}}function la(e){var t;((t=e==null?void 0:e.detail)==null?void 0:t.name)===ra&&rt()}function ua(){const{addButton:e}=be(),t=document.getElementById("addLocoMore"),n=document.getElementById("addLocoMenu");if(!t||!n||!e)return;e.addEventListener("click",()=>{Z("create",null,()=>B(),!1)});const a=()=>{n.hidden=!1,t.setAttribute("aria-expanded","true"),document.addEventListener("click",o,{capture:!0})},i=()=>{n.hidden=!0,t.setAttribute("aria-expanded","false"),document.removeEventListener("click",o,{capture:!0})},o=r=>{n.contains(r.target)||t.contains(r.target)||i()};t.addEventListener("click",r=>{r.stopPropagation(),n.hidden?a():i()}),n.addEventListener("click",r=>{const s=r.target.closest(".menu-item");if(!s)return;const c=s.dataset.action;i(),c==="manual"&&Z("create",null,()=>B(),!1),c==="copy"&&oa(document.getElementById("addLocoMore")),c==="upload"&&zn()})}function da(){document.addEventListener("panel:changed",la),ua();const{panelElement:e}=be();e&&!e.hasAttribute("hidden")&&rt()}const st=Object.freeze({panel:"#panelSettings",connectionsSelect:"#jmriConnectionSelect"}),ma="settings",fa="Loading settings…";async function pa(){document.addEventListener("panel:changed",ga);const e=l(st.connectionsSelect);e&&e.addEventListener("change",ha)}async function ga(e){var t;if(((t=e==null?void 0:e.detail)==null?void 0:t.name)===ma)try{await S(async()=>{await ya()},fa)}catch{}}async function ya(){const e=await Ve();ze(e);const t=l(st.connectionsSelect);if(t){t.innerHTML="";for(const n of e){const a=document.createElement("option");a.value=n.systemPrefix,a.textContent=n.userName,n.systemPrefix===(V==null?void 0:V.systemPrefix)&&(a.selected=!0),t.appendChild(a)}}}async function ha(e){var n;const t=((n=e==null?void 0:e.target)==null?void 0:n.value)||"I";await Mt(t)}function va(e){let t=null;return Array.isArray(e)?t=e:e&&typeof e=="object"&&(Array.isArray(e.data)?t=e.data:Array.isArray(e.turnouts)?t=e.turnouts:Array.isArray(e.list)?t=e.list:Array.isArray(e.items)?t=e.items:t=Object.values(e)),(t||[]).map(we).filter(Boolean)}function we(e){if(!e)return null;const t=(e.data&&typeof e.data=="object"?e.data:e)||{},n=t.name||"",a=t.userName||"",i=t.comment||"",o=!!t.inverted,r=t.state;let s="Unknown",c=!1,m=!1,p=!0;return r===4&&!o||r===2&&o?(s="Thrown",c=!0,p=!1):(r===2&&!o||r===4&&o)&&(s="Closed",m=!0,p=!1),{title:a,address:n,comment:i,state:r,normalisedState:s,isThrown:c,isClosed:m,isUnknown:p,inverted:o,name:n,userName:a,data:t}}async function ct(e){const t=String(e.systemName||"").trim();if(!t)throw new Error("System Name is required");const n={name:t,...e.userName!=null?{userName:e.userName}:{},...e.comment!=null?{comment:e.comment}:{},...e.inverted!=null?{inverted:!!e.inverted}:{}},a=`/json/turnout/${encodeURIComponent(t)}`,i=await K("PUT",a,n),r=Object.prototype.hasOwnProperty.call(n,"userName")||Object.prototype.hasOwnProperty.call(n,"comment")||Object.prototype.hasOwnProperty.call(n,"inverted")?await K("POST",a,n):i;return await We(G),we(r)}async function te(e,t){const n=String(e||"").trim();if(!n)throw new Error("System Name is required");const a={name:n,...t.userName!=null?{userName:t.userName}:{},...t.comment!=null?{comment:t.comment}:{},...t.inverted!=null?{inverted:!!t.inverted}:{},...t.state!=null?{state:t.state}:{}},i=await K("POST",`/json/turnout/${encodeURIComponent(n)}`,a);return we(i)}async function ba(e){const t=String(e||"").trim();if(!t)throw new Error("System Name is required");await K("DELETE",`/json/turnout/${encodeURIComponent(t)}`)}const z=Object.freeze({panel:"#panelTurnouts",list:"#turnoutsList",addButton:"#turnoutsAddBtn"});function lt(e=document){const t=n=>e.querySelector(n);return{panelElement:t(z.panel),listElement:t(z.list),addButtonElement:t(z.addButton)}}function wa({isThrown:e=!1,isUnknown:t=!1}){return`
<svg class="turnout-icon ${t?"unknown":e?"thrown":"closed"}" viewBox="0 0 64 40" width="64" height="40" aria-hidden="true">
  <g fill="none" stroke-width="4" stroke-linecap="round">
    <!-- straight route -->
    <path class="trk base"    d="M4 20 H60" />
    <!-- diverging route -->
    <path class="trk diverge" d="M4 20 Q30 4 60 4" />
  </g>
  ${t?`
    <g class="badge" aria-hidden="true">
      <!-- question mark -->
      <text class="badge-text" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" x="32" font-size="48" y="35">?</text>
    </g>`:""}
</svg>`}function Sa(e,t={}){var r;const n=document.createElement("article");n.className="card";const a=e.title||"(unnamed)",i=[];e.address&&i.push(e.address),(e.normalisedState||e.normalizedState)&&i.push(e.normalisedState||e.normalizedState);const o=i.join(" · ");return n.innerHTML=`
    <div class="card-img" aria-hidden="true" data-act="toggle">
      ${wa(e)}
    </div>
    <div class="card-body card-body-turnout">
      <div class="card-title">${C(a)}</div>
      <div class="card-sub">${C(o)}</div>
      ${e.comment?`<div class="card-sub">${C(e.comment)}</div>`:""}
    </div>
  `,(r=n.querySelector('[data-act="toggle"]'))==null||r.addEventListener("click",s=>{var c;s.stopPropagation(),(c=t.onToggle)==null||c.call(t,e)}),n.addEventListener("click",s=>{var c;s.stopPropagation(),(c=t.onEdit)==null||c.call(t,e)}),n}const re=new Map;async function Ea(e="turnout"){const t=String(e);if(re.has(t))return re.get(t);const n=await fetch(`/api/jmri/prefix?type=${encodeURIComponent(e)}`,{headers:{Accept:"application/json"}});if(!n.ok)throw new Error(`Prefix fetch failed: ${n.status}`);const a=await n.json();return re.set(t,a),a}const f={dialog:"#turnoutDialog",form:"#turnoutForm",title:"#turnoutDialogTitle",prefix:"#toPrefixSelect",system:"#toSystemName",user:"#toUserName",comment:"#toComment",inverted:"#toInverted",state:"#toState",save:"#turnoutSave",cancel:"#turnoutCancel",close:"#turnoutClose",delete:"#turnoutDelete",countRow:"#toCountRow",count:"#toCount"},Na="Saving…";let X=null,ut="edit",dt=[],se=null,ce=null,x=null,le=null;async function Ca(){const e=l(f.prefix);if(!e)return[];const t=await Ea("turnout");dt=Array.isArray(t)?t.map(n=>n.systemNamePrefix).filter(Boolean):[],e.innerHTML="";for(const n of t){const a=document.createElement("option");a.value=n.systemNamePrefix,a.textContent=n.connectionName?`${n.systemNamePrefix} — ${n.connectionName}`:n.systemNamePrefix,e.appendChild(a)}return t}function La(e){if(!e)return null;for(const t of dt)if(e.startsWith(t))return t;return null}function Aa(e,t){const n=(e||"").trim();if(!n)return"";let a=n;t&&n.startsWith(t)?a=n.slice(t.length):a=n.replace(/^[A-Za-z]+/,"");const i=a.match(/\d+/);return i?i[0]:""}function ue(e,t=null){var c;const n=l(f.system),a=l(f.user),i=l(f.comment),o=l(f.inverted),r=l(f.state),s=(e==null?void 0:e.name)||(e==null?void 0:e.address)||((c=e==null?void 0:e.data)==null?void 0:c.name)||"";n.value=Aa(s,t),a.value=(e==null?void 0:e.userName)||(e==null?void 0:e.title)||"",i.value=(e==null?void 0:e.comment)||"",o.checked=!!(e!=null&&e.inverted),r.value=""}function Ia(){return{dccDigits:F(f.system),selectedPrefix:F(f.prefix),userName:F(f.user),comment:F(f.comment),inverted:Jt(f.inverted),stateChoice:F(f.state)}}function ka(e,t){return e?e==="thrown"?t?2:4:t?4:2:null}function Ta(){var t;const e=Number(((t=l(f.count))==null?void 0:t.value)??1);return Number.isFinite(e)&&e>0?Math.min(e,64):1}function Da(e){const t=l(f.countRow);t&&(t.hidden=!e)}function Fa(e){const t=l(f.title);t&&(t.textContent=e)}function $a(){const e=l(f.dialog);e&&!e.open&&e.showModal(),Ye(e)}function Se(){const e=l(f.dialog);if(e)try{e.open&&e.close()}catch(t){console.warn(t)}}async function Oa(e){const t=Ia(),n=["create","sequential"].includes(ut),a=n?Ma(t):null;if(a){u==null||u(a);return}const i=xa(e,t,n),o=Pa(t),r=n?Ta():1;try{let s="Saved";await S(async()=>{if(n&&r>1)s=await ja(t,r,o);else if(n)await Ra(i,t,o);else{const c=Ba(e,i);await qa(c,t,o)}},Na),Se(),u==null||u(s),X==null||X()}catch(s){u==null||u((s==null?void 0:s.message)||"Save failed")}}function Ma(e){const t=ge(e.dccDigits,ee);return t||(e.selectedPrefix?null:"Select a connection/prefix")}function xa(e,t,n){var a;return n?`${t.selectedPrefix||""}${t.dccDigits||""}`.trim():((e==null?void 0:e.name)||(e==null?void 0:e.address)||((a=e==null?void 0:e.data)==null?void 0:a.name)||"").trim()}function Pa(e){return ka(e.stateChoice,e.inverted)}function Ba(e,t){var n;return(e==null?void 0:e.name)||(e==null?void 0:e.address)||((n=e==null?void 0:e.data)==null?void 0:n.name)||t}function Ua(e,t,n){const a=(e||"").trim();return a?n?a:`${a} ${t}`:String(t)}async function Ra(e,t,n){const a=(t.userName||"").trim()||String(t.dccDigits||"");await ct({systemName:e,userName:a,comment:t.comment,inverted:t.inverted}),n!==null&&await te(e,{state:n})}async function qa(e,t,n){const a={userName:t.userName,comment:t.comment,inverted:t.inverted};n!==null&&(a.state=n),await te(e,a)}async function ja(e,t,n){const a=Number(e.dccDigits);if(!Number.isFinite(a))throw new Error("Invalid base DCC address");const i=e.selectedPrefix||"";if(!i)throw new Error("Select a connection/prefix");let o=0;const r=[];for(let c=0;c<t;c++){const m=a+c,p=`${i}${m}`,v=Ua(e.userName,m,c===0);try{await ct({systemName:p,userName:v,comment:e.comment,inverted:e.inverted}),n!==null&&await te(p,{state:n}),o+=1}catch(h){r.push({dcc:m,message:(h==null?void 0:h.message)||"create failed"})}}if(r.length===0)return`Created ${o} turnouts`;if(o===0)return`No turnouts created (${r.length} failed)`;const s=r.slice(0,3).map(c=>c.dcc).join(", ");return`Created ${o}/${t}; failed: ${r.length} (${s}${r.length>3?"…":""})`}async function Ee(e,t,n){var o,r,s,c,m,p,v,h,E;ut=e,X=n||null,Fa(["create","sequential"].includes(e)?"Add Turnout":"Edit Turnout"),Da(e==="sequential");const a=l(f.count);a&&(a.value="1");try{await Ca();const b=l(f.prefix);if(e==="edit"){const _=(t==null?void 0:t.name)||(t==null?void 0:t.address)||((o=t==null?void 0:t.data)==null?void 0:o.name)||"",D=La(_);b&&D&&(b.value=D),l(f.delete).hidden=!1,ue(t,D)}else b&&b.options.length>0&&!b.value&&(b.value=b.options[0].value),l(f.delete).hidden=!0,ue(null,null)}catch{ue(e==="edit"?t:null,null)}const i=l(f.system);i&&i.toggleAttribute("readonly",e==="edit"),se&&se(),se=Xe({input:i,saveButton:l(f.save),rules:ee,errorId:"turnoutSystemNameError",disableSaveWhenInvalid:!0}),$a(),(r=l(f.save))==null||r.removeEventListener("click",ce),(s=l(f.delete))==null||s.removeEventListener("click",le),(c=l(f.cancel))==null||c.removeEventListener("click",x),(m=l(f.close))==null||m.removeEventListener("click",x),ce=()=>Oa(t),le=()=>pt(t),x=()=>Se(),(p=l(f.delete))==null||p.addEventListener("click",le),(v=l(f.save))==null||v.addEventListener("click",ce),(h=l(f.cancel))==null||h.addEventListener("click",x),(E=l(f.close))==null||E.addEventListener("click",x)}const _a="turnouts",mt="Loading turnouts…",Ha="Deleting…",me={initialized:!1,items:[]};function qe(e){try{u==null||u(e)}catch(t){console.warn(t)}}async function ne(){const e=await Ft(),t=va(e);return me.items=t,t}function U(e){const t=l(z.list);if(t&&(t.innerHTML="",(e||[]).forEach(n=>{const a=Sa(n,{onToggle:()=>Ga(n),onEdit:()=>za(n),onDelete:()=>pt(n)});t.appendChild(a)}),!e||e.length===0)){const n=document.createElement("div");n.className="empty",n.innerHTML=`
      <div class="empty-title">No turnouts yet</div>
      <div class="empty-subtitle">Add a turnout to get started.</div>
    `,t.appendChild(n)}}async function ft(){if(!me.initialized){me.initialized=!0,U([]);try{await S(async()=>{const e=await ne();U(e)},mt)}catch{}}}function Wa(e){var t;((t=e==null?void 0:e.detail)==null?void 0:t.name)===_a&&ft()}function Ne(){return S(async()=>{const e=await ne();U(e)},mt)}function je(){Ee("create",null,()=>{Ne()})}function Va(){Ee("sequential",null,()=>{Ne()})}function za(e){Ee("edit",e,()=>{Ne()})}async function pt(e){var a;const t=e.name||e.address||((a=e.data)==null?void 0:a.name);if(!(!t||!confirm(`Delete turnout "${e.title||t}"?
This cannot be undone.`)))try{await S(async()=>{await ba(t);const i=await ne();U(i)},Ha),qe("Turnout deleted")}catch{qe("Delete failed")}finally{Se()}}function Xa(){document.addEventListener("panel:changed",Wa),Ja();const{panelElement:e}=lt();e&&!e.hasAttribute("hidden")&&ft()}function Ja(){const{addButtonElement:e}=lt(),t=document.getElementById("addTurnoutMore"),n=document.getElementById("addTurnoutMenu");if(!t||!n||!e)return;e.addEventListener("click",()=>{je()});const a=()=>{n.hidden=!1,t.setAttribute("aria-expanded","true"),document.addEventListener("click",o,{capture:!0})},i=()=>{n.hidden=!0,t.setAttribute("aria-expanded","false"),document.removeEventListener("click",o,{capture:!0})},o=r=>{n.contains(r.target)||t.contains(r.target)||i()};t.addEventListener("click",r=>{r.stopPropagation(),n.hidden?a():i()}),n.addEventListener("click",r=>{const s=r.target.closest(".menu-item");if(!s)return;const c=s.dataset.action;i(),c==="single"&&je(),c==="sequential"&&Va()})}function Ka(e,t){return e?t?2:4:t?4:2}async function Ga(e){var r;const t=e.name||e.address||((r=e.data)==null?void 0:r.name);if(!t)return;const n=!!e.isThrown,i=!!e.isClosed?!0:!n,o=Ka(i,!!e.inverted);try{await te(t,{state:o});const s=await ne();U(s);try{u==null||u(`Turnout ${i?"Thrown":"Closed"}`)}catch(c){console.warn(c)}}catch{try{u==null||u("Toggle failed")}catch(s){console.warn(s)}}}(function(){Xt(),yt(),xt(),gt(),da(),pa(),Xa()})();
//# sourceMappingURL=index-wTdFORHR.js.map
